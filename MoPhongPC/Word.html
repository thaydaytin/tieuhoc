<!DOCTYPE html>
<html lang="vi" style="height: 100%; width: 100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mô phỏng Word cho Học sinh</title>
    <!-- Tailwind CSS CDN để tạo kiểu nhanh chóng và đẹp mắt -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Ngăn cuộn trang chính */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Màu nền xám nhạt */
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: none;
            margin: 10px;
        }
        @media (max-width: 768px) {
            .container {
                margin: 0;
                border-radius: 0;
            }
        }
        .menu-bar {
            background-color: #e0e0e0;
            border-bottom: 1px solid #d0d0d0;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            flex-shrink: 0;
        }
        .tab-header {
            display: flex;
            padding: 0 20px;
            border-bottom: 1px solid #d0d0d0;
        }
        .tab-button {
            padding: 10px 15px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #555;
            transition: all 0.2s ease-in-out;
            border-bottom: 3px solid transparent;
            margin: 0 4px;
        }
        .tab-button:hover {
            color: #333;
            background-color: #f0f0f0;
        }
        .tab-button.active {
            color: #4a90e2;
            border-bottom-color: #4a90e2;
            background-color: #f9f9f9;
        }
        .tab-content-container {
            padding: 12px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .tab-content {
            display: none;
            width: 100%;
        }
        .tab-content.active {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .menu-bar button,
        .menu-bar select,
        .menu-bar input[type="color"] {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 38px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        .menu-bar button:hover,
        .menu-bar select:hover {
            background-color: #e9e9e9;
            border-color: #bbb;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .menu-bar button:active {
            background-color: #dcdcdc;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .menu-bar button.active {
            background-color: #c0c0c0;
            border-color: #a0a0a0;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .menu-bar button.primary {
            background-color: #4a90e2;
            color: white;
            border-color: #4a90e2;
        }
        .menu-bar button.primary:hover {
            background-color: #357bd8;
            border-color: #357bd8;
        }

        input[type="color"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 40px;
            height: 38px;
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        input[type="color"]::-moz-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-moz-color-swatch {
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .icon {
            font-size: 1.2rem;
        }
        #fileInput {
            display: none;
        }

        .document-area {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
        }
        .document-frame {
            border: 1px solid #e0e0e0;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            min-height: 600px;
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }
        iframe::-webkit-scrollbar {
            width: 8px;
        }
        iframe::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        iframe::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        iframe::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Modals */
        .modal {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 24px;
            width: 90%;
            max-width: 400px;
        }
        .modal input {
            @apply mt-1 block w-full p-2 border border-gray-300 rounded-md;
        }
        .modal button {
            @apply px-4 py-2 rounded-md transition-colors duration-200;
        }
        .modal button.primary {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        .modal button.secondary {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }

        @media (max-width: 768px) {
            .menu-bar .tab-header {
                padding: 0 10px;
            }
            .menu-bar .tab-button {
                padding: 8px 10px;
                font-size: 0.8rem;
                margin: 0 2px;
            }
            .tab-content-container {
                padding: 10px;
                gap: 8px;
            }
            .menu-bar button,
            .menu-bar select,
            .menu-bar input[type="color"] {
                padding: 6px 10px;
                font-size: 0.85rem;
                min-width: 35px;
                min-height: 35px;
            }
            .document-area {
                padding: 10px;
            }
            .document-frame {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="menu-bar">
            <div class="tab-header" id="tabHeader">
                <button class="tab-button active" data-tab="file">File</button>
                <button class="tab-button" data-tab="home">Home</button>
                <button class="tab-button" data-tab="insert">Insert</button>
            </div>
            <div class="tab-content-container">
                <!-- File Tab Content -->
                <div id="fileTabContent" class="tab-content active">
                    <button id="clearDocBtn" class="primary" title="Tạo tài liệu mới (Xóa nội dung)">
                        <svg class="icon w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586l-1.293-1.293z" clip-rule="evenodd"></path></svg>
                        New
                    </button>
                    <button id="saveBtn" class="primary" title="Lưu tài liệu">
                        <svg class="icon w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v3a1 1 0 002 0V3a1 1 0 00-1-1zM5 5a2 2 0 00-2 2v8a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-3V3a3 3 0 00-3-3H9a3 3 0 00-3 3v2H5zm5 5a1 1 0 011 1v3a1 1 0 11-2 0v-3a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        Save
                    </button>
                    <input type="file" id="fileInput" accept=".html,.txt" class="hidden">
                    <button id="openFileBtn" class="primary" title="Mở tài liệu từ tệp">
                        <svg class="icon w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z"></path></svg>
                        Open
                    </button>
                </div>

                <!-- Home Tab Content -->
                <div id="homeTabContent" class="tab-content">
                    <select id="fontFamilySelect" title="Chọn phông chữ">
                        <option value="Arial">Arial</option>
                        <option value="Verdana">Verdana</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Courier New">Courier New</option>
                        <option value="Inter">Inter (Mặc định)</option>
                    </select>

                    <select id="fontSizeSelect" title="Chọn cỡ chữ">
                        <option value="1">8px</option>
                        <option value="2">10px</option>
                        <option value="3">12px</option>
                        <option value="4" selected>14px</option>
                        <option value="5">18px</option>
                        <option value="6">24px</option>
                        <option value="7">36px</option>
                    </select>

                    <input type="color" id="fontColorInput" value="#000000" title="Chọn màu chữ">
                    <input type="color" id="backColorInput" value="#ffffff" title="Chọn màu nền văn bản">

                    <button id="boldBtn" title="In đậm">
                        <span class="font-bold">B</span>
                    </button>
                    <button id="italicBtn" title="In nghiêng">
                        <span class="italic">I</span>
                    </button>
                    <button id="underlineBtn" title="Gạch chân">
                        <span class="underline">U</span>
                    </button>

                    <button id="justifyLeftBtn" title="Căn trái">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path></svg>
                    </button>
                    <button id="justifyCenterBtn" title="Căn giữa">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 8a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 12a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 16a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"></path></svg>
                    </button>
                    <button id="justifyRightBtn" title="Căn phải">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path></svg>
                    </button>
                    <button id="justifyFullBtn" title="Căn đều">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 8a1 1 0 011-1h12a1 1 0 110 2H5a1 1 0 01-1-1zM3 12a1 1 0 011-1h12a1 1 0 110 2H5a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H5a1 1 0 01-1-1z"></path></svg>
                    </button>

                    <button id="unorderedListBtn" title="Danh sách dấu đầu dòng">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 8a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 12a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 16a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"></path></svg>
                        <span class="ml-1">Bullet</span>
                    </button>
                    <button id="orderedListBtn" title="Danh sách số thứ tự">
                        <svg class="icon w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M4 4a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 8a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 12a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM4 16a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z"></path></svg>
                        <span class="ml-1">Numbered</span>
                    </button>
                </div>

                <!-- Insert Tab Content -->
                <div id="insertTabContent" class="tab-content">
                    <button id="insertImageBtn" class="primary" title="Chèn ảnh">
                        <svg class="icon w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-4 3 3 5-5V15z" clip-rule="evenodd"></path></svg>
                        Pictures
                    </button>
                    <button id="insertLinkBtn" class="primary" title="Chèn liên kết">
                        <svg class="icon w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12 2h-2a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V4a2 2 0 00-2-2zM4 9a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H4zm8 0a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z"></path></svg>
                        Link
                    </button>
                </div>
            </div>
        </div>

        <div class="document-area">
            <iframe id="documentFrame" class="document-frame"></iframe>
        </div>
    </div>

    <!-- Modals for Insert Image and Insert Link -->
    <div id="insertImageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="modal">
            <h3 class="text-xl font-bold mb-4">Chèn ảnh</h3>
            <div class="mb-4">
                <label for="imageUrl" class="block text-sm font-medium text-gray-700">URL ảnh:</label>
                <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">
            </div>
            <div class="text-center mb-4">Hoặc</div>
            <div class="mb-4">
                <label for="imageFile" class="block text-sm font-medium text-gray-700">Tải ảnh lên:</label>
                <input type="file" id="imageFile" accept="image/*">
            </div>
            <div class="flex justify-end gap-2">
                <button class="secondary" onclick="hideInsertImageModal()">Cancel</button>
                <button class="primary" onclick="insertImage()">Insert</button>
            </div>
        </div>
    </div>

    <div id="insertLinkModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
        <div class="modal">
            <h3 class="text-xl font-bold mb-4">Chèn liên kết</h3>
            <div class="mb-4">
                <label for="linkText" class="block text-sm font-medium text-gray-700">Văn bản hiển thị:</label>
                <input type="text" id="linkText" placeholder="Nhập văn bản">
            </div>
            <div class="mb-4">
                <label for="linkUrl" class="block text-sm font-medium text-gray-700">URL:</label>
                <input type="text" id="linkUrl" placeholder="https://example.com">
            </div>
            <div class="flex justify-end gap-2">
                <button class="secondary" onclick="hideInsertLinkModal()">Cancel</button>
                <button class="primary" onclick="insertLink()">Insert</button>
            </div>
        </div>
    </div>

    <script>
        // Get DOM elements
        const documentFrame = document.getElementById('documentFrame');
        let doc;
        
        // Drag-and-drop state variables
        let isDragging = false;
        let activeDraggable = null;
        let offsetX = 0;
        let offsetY = 0;
        
        // New state variable for tracking the selected image for deletion
        let selectedDraggable = null;

        const tabHeader = document.getElementById('tabHeader');
        const fileTabContent = document.getElementById('fileTabContent');
        const homeTabContent = document.getElementById('homeTabContent');
        const insertTabContent = document.getElementById('insertTabContent');

        const clearDocBtn = document.getElementById('clearDocBtn');
        const saveBtn = document.getElementById('saveBtn');
        const fileInput = document.getElementById('fileInput');
        const openFileBtn = document.getElementById('openFileBtn');

        const fontFamilySelect = document.getElementById('fontFamilySelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const fontColorInput = document.getElementById('fontColorInput');
        const backColorInput = document.getElementById('backColorInput');
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const justifyLeftBtn = document.getElementById('justifyLeftBtn');
        const justifyCenterBtn = document.getElementById('justifyCenterBtn');
        const justifyRightBtn = document.getElementById('justifyRightBtn');
        const justifyFullBtn = document.getElementById('justifyFullBtn');
        const unorderedListBtn = document.getElementById('unorderedListBtn');
        const orderedListBtn = document.getElementById('orderedListBtn');

        const insertImageBtn = document.getElementById('insertImageBtn');
        const insertLinkBtn = document.getElementById('insertLinkBtn');
        const insertImageModal = document.getElementById('insertImageModal');
        const imageUrlInput = document.getElementById('imageUrl');
        const imageFileInput = document.getElementById('imageFile');
        const insertLinkModal = document.getElementById('insertLinkModal');
        const linkTextInput = document.getElementById('linkText');
        const linkUrlInput = document.getElementById('linkUrl');

        /**
         * Initializes the iframe for editing.
         * This function is called when the iframe finishes loading.
         */
        function initializeIframe() {
            doc = documentFrame.contentWindow.document;

            // Write a full HTML document into the iframe with necessary styles
            doc.open();
            doc.write(`
                <html style="height: 100%; width: 100%;">
                <head>
                    <style>
                        body {
                            font-family: 'Arial', sans-serif;
                            font-size: 16px;
                            padding: 20px;
                            line-height: 1.5;
                            word-wrap: break-word;
                            min-height: calc(100% - 40px);
                            outline: none;
                            margin: 0;
                            position: relative; /* Essential for absolute positioning of images */
                        }
                        p { margin: 0; padding: 0; }
                        
                        /* Styles for draggable images */
                        .draggable-image-container {
                            position: absolute;
                            z-index: 100;
                            cursor: grab;
                            border: 2px dashed transparent; /* Border for visual feedback */
                            transition: border 0.2s ease;
                            user-select: none; /* Prevent text selection while dragging */
                        }
                        .draggable-image-container:hover {
                            border-color: #4a90e2;
                        }
                        .draggable-image-container.selected {
                            border: 2px solid #4a90e2; /* Solid border when selected */
                        }
                        .draggable-image-container img {
                            display: block;
                            max-width: 100%;
                            height: auto;
                            pointer-events: none; /* Allows dragging by clicking anywhere on the image */
                        }
                    </style>
                </head>
                <body contenteditable="true">
                    ${localStorage.getItem('wordDocumentContent') || '<p>Bắt đầu gõ văn bản của bạn tại đây...</p>'}
                </body>
                </html>
            `);
            doc.close();

            setTimeout(() => {
                try {
                    doc.body.focus();
                } catch (e) {
                    console.error('Failed to focus iframe body:', e);
                }
            }, 100);

            // Add event listeners for formatting and drag-and-drop within the iframe
            doc.body.addEventListener('input', updateFormattingButtons);
            doc.body.addEventListener('mouseup', updateFormattingButtons);
            doc.body.addEventListener('keyup', updateFormattingButtons);
            
            // --- Logic for selecting and deleting images ---
            
            // Add a global keydown listener to the iframe document to handle deletion
            doc.addEventListener('keydown', (e) => {
                // Check if an image is selected and the delete or backspace key is pressed
                if (selectedDraggable && (e.key === 'Delete' || e.key === 'Backspace')) {
                    // Remove the selected image element from the document
                    selectedDraggable.remove();
                    // Clear the selection
                    selectedDraggable = null;
                    // Prevent the default browser action (like navigating back for backspace)
                    e.preventDefault();
                }
            });

            // --- Drag and Drop & Selection Logic ---
            doc.body.addEventListener('mousedown', (e) => {
                const target = e.target.closest('.draggable-image-container');
                if (target) {
                    // This is an image, so we select and prepare for dragging
                    
                    // First, deselect any previously selected image
                    if (selectedDraggable && selectedDraggable !== target) {
                        selectedDraggable.classList.remove('selected');
                    }
                    
                    // Select the new image
                    selectedDraggable = target;
                    selectedDraggable.classList.add('selected');
                    
                    // Prepare for dragging
                    isDragging = true;
                    activeDraggable = target;
                    // Calculate initial offset
                    offsetX = e.clientX - activeDraggable.getBoundingClientRect().left;
                    offsetY = e.clientY - activeDraggable.getBoundingClientRect().top;
                    activeDraggable.style.cursor = 'grabbing';
                    e.preventDefault(); // Prevent default text selection behavior
                } else {
                    // The user clicked on the document body, not an image
                    // Deselect any currently selected image
                    if (selectedDraggable) {
                        selectedDraggable.classList.remove('selected');
                        selectedDraggable = null;
                    }
                }
            });

            doc.body.addEventListener('mousemove', (e) => {
                if (!isDragging || !activeDraggable) return;

                // Calculate new position
                let newX = e.clientX - offsetX;
                let newY = e.clientY - offsetY;

                // Restrict image to stay within the document boundaries
                const bodyRect = doc.body.getBoundingClientRect();
                const elementRect = activeDraggable.getBoundingClientRect();

                // Left boundary
                newX = Math.max(0, newX);
                // Top boundary
                newY = Math.max(0, newY);
                // Right boundary
                newX = Math.min(newX, bodyRect.width - elementRect.width);
                // Bottom boundary
                newY = Math.min(newY, bodyRect.height - elementRect.height);

                activeDraggable.style.left = `${newX}px`;
                activeDraggable.style.top = `${newY}px`;
            });

            doc.body.addEventListener('mouseup', () => {
                if (isDragging && activeDraggable) {
                    activeDraggable.style.cursor = 'grab';
                }
                isDragging = false;
                activeDraggable = null;
            });
            // --- End Drag and Drop & Selection Logic ---
        }

        /**
         * Switches between different tabs (File, Home, Insert).
         * @param {string} tabId - The ID of the tab to open (e.g., 'file', 'home', 'insert').
         */
        function openTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(`${tabId}TabContent`).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        /**
         * Applies formatting to the selected text in the document.
         * @param {string} command - The command to execute (e.g., 'bold', 'italic', 'fontSize').
         * @param {string} [value=null] - The value for the command.
         */
        function formatDoc(command, value = null) {
            if (doc) {
                doc.execCommand(command, false, value);
                documentFrame.contentWindow.focus();
                updateFormattingButtons();
            }
        }

        /**
         * Updates the active state of formatting buttons.
         */
        function updateFormattingButtons() {
            if (!doc) return;
            boldBtn.classList.toggle('active', doc.queryCommandState('bold'));
            italicBtn.classList.toggle('active', doc.queryCommandState('italic'));
            underlineBtn.classList.toggle('active', doc.queryCommandState('underline'));

            // The following logic to check font family, size and color is for updating the UI controls.
            const currentFont = doc.queryCommandValue('fontName').replace(/"/g, '');
            if (fontFamilySelect.value !== currentFont) {
                const option = Array.from(fontFamilySelect.options).find(opt => opt.value.toLowerCase() === currentFont.toLowerCase());
                if (option) fontFamilySelect.value = option.value;
            }

            const currentSize = doc.queryCommandValue('fontSize');
            if (fontSizeSelect.value !== currentSize) {
                fontSizeSelect.value = currentSize;
            }

            const currentColor = doc.queryCommandValue('foreColor');
            if (fontColorInput.value !== currentColor) {
                fontColorInput.value = currentColor;
            }

            const currentBackColor = doc.queryCommandValue('backColor');
            if (backColorInput.value !== currentBackColor) {
                backColorInput.value = currentBackColor;
            }
        }

        /**
         * Clears the current document content.
         */
        function clearDocument() {
            if (doc) {
                doc.body.innerHTML = '<p>Bắt đầu gõ văn bản của bạn tại đây...</p>';
                localStorage.removeItem('wordDocumentContent');
                showMessage('Đã tạo tài liệu mới.', 'info');
                setTimeout(() => {
                    doc.body.focus();
                }, 50);
            }
        }

        /**
         * Saves the current document content to local storage.
         */
        function saveDocument() {
            if (doc) {
                localStorage.setItem('wordDocumentContent', doc.body.innerHTML);
                showMessage('Đã lưu tài liệu!', 'success');
            } else {
                showMessage('Không thể lưu tài liệu. Vui lòng thử lại.', 'error');
            }
        }

        /**
         * Handles opening a file from the user's local system.
         */
        function openFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                if (doc) {
                    doc.body.innerHTML = e.target.result;
                    showMessage(`Đã mở tệp "${file.name}".`, 'success');
                    setTimeout(() => {
                        doc.body.focus();
                    }, 50);
                }
            };
            reader.onerror = function() {
                showMessage('Không thể đọc tệp. Vui lòng đảm bảo tệp hợp lệ.', 'error');
            };
            reader.readAsText(file);
        }

        /**
         * Shows the modal for inserting an image.
         */
        function showInsertImageModal() {
            insertImageModal.classList.remove('hidden');
            imageUrlInput.value = '';
            imageFileInput.value = '';
        }

        /**
         * Hides the modal for inserting an image.
         */
        function hideInsertImageModal() {
            insertImageModal.classList.add('hidden');
        }

        /**
         * Inserts a draggable image into the document from a URL or a file.
         */
        function insertImage() {
            const imageUrl = imageUrlInput.value;
            const imageFile = imageFileInput.files[0];

            if (doc) {
                let imageHtml = '';
                // Get the current cursor position to place the image
                const selection = doc.getSelection();
                const range = selection.getRangeAt(0);
                const rect = range.getBoundingClientRect();
                const bodyRect = doc.body.getBoundingClientRect();
                const topPos = rect.top - bodyRect.top + doc.body.scrollTop;
                const leftPos = rect.left - bodyRect.left;

                if (imageUrl) {
                    imageHtml = `<div class="draggable-image-container" style="top:${topPos}px; left:${leftPos}px; width:200px;" contenteditable="false"><img src="${imageUrl}" alt="Ảnh người dùng chèn" /></div>`;
                    doc.body.insertAdjacentHTML('beforeend', imageHtml);
                    showMessage('Đã chèn ảnh từ URL.', 'success');
                } else if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageHtml = `<div class="draggable-image-container" style="top:${topPos}px; left:${leftPos}px; width:200px;" contenteditable="false"><img src="${e.target.result}" alt="Ảnh người dùng chèn" /></div>`;
                        doc.body.insertAdjacentHTML('beforeend', imageHtml);
                        showMessage('Đã chèn ảnh từ tệp.', 'success');
                    };
                    reader.onerror = function() {
                        showMessage('Không thể đọc tệp ảnh.', 'error');
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    showMessage('Vui lòng nhập URL hoặc chọn tệp ảnh.', 'info');
                    return;
                }
                documentFrame.contentWindow.focus();
                hideInsertImageModal();
            }
        }

        /**
         * Shows the modal for inserting a link.
         */
        function showInsertLinkModal() {
            insertLinkModal.classList.remove('hidden');
            linkTextInput.value = doc.getSelection().toString();
            linkUrlInput.value = '';
        }

        /**
         * Hides the modal for inserting a link.
         */
        function hideInsertLinkModal() {
            insertLinkModal.classList.add('hidden');
        }

        /**
         * Inserts a hyperlink into the document.
         */
        function insertLink() {
            const linkText = linkTextInput.value;
            const linkUrl = linkUrlInput.value;

            if (doc) {
                if (linkUrl) {
                    const selection = doc.getSelection();
                    if (selection.toString().length > 0) {
                        doc.execCommand('createLink', false, linkUrl);
                    } else if (linkText) {
                        doc.execCommand('insertHTML', false, `<a href="${linkUrl}" target="_blank">${linkText}</a>`);
                    } else {
                        doc.execCommand('createLink', false, linkUrl);
                    }
                    showMessage('Đã chèn liên kết.', 'success');
                } else {
                    showMessage('Vui lòng nhập URL liên kết.', 'info');
                    return;
                }
                documentFrame.contentWindow.focus();
                hideInsertLinkModal();
            }
        }

        /**
         * Displays a temporary message to the user.
         */
        function showMessage(message, type) {
            let messageBox = document.getElementById('messageBox');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'messageBox';
                messageBox.className = 'fixed bottom-4 right-4 p-3 rounded-md shadow-lg text-white z-50 transition-opacity duration-300 opacity-0';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.className = messageBox.className.replace(/bg-(green|red|blue)-\d{3}/g, '');
            if (type === 'success') {
                messageBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-500');
            } else {
                messageBox.classList.add('bg-blue-500');
            }

            messageBox.classList.remove('opacity-0');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // --- Event Listeners ---

        tabHeader.addEventListener('click', (event) => {
            if (event.target.classList.contains('tab-button')) {
                const tabId = event.target.dataset.tab;
                openTab(tabId);
            }
        });

        clearDocBtn.addEventListener('click', clearDocument);
        saveBtn.addEventListener('click', saveDocument);
        openFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', openFile);

        fontFamilySelect.addEventListener('change', (event) => formatDoc('fontName', event.target.value));
        fontSizeSelect.addEventListener('change', (event) => formatDoc('fontSize', event.target.value));
        fontColorInput.addEventListener('input', (event) => formatDoc('foreColor', event.target.value));
        backColorInput.addEventListener('input', (event) => formatDoc('backColor', event.target.value));
        boldBtn.addEventListener('click', () => formatDoc('bold'));
        italicBtn.addEventListener('click', () => formatDoc('italic'));
        underlineBtn.addEventListener('click', () => formatDoc('underline'));
        justifyLeftBtn.addEventListener('click', () => formatDoc('justifyLeft'));
        justifyCenterBtn.addEventListener('click', () => formatDoc('justifyCenter'));
        justifyRightBtn.addEventListener('click', () => formatDoc('justifyRight'));
        justifyFullBtn.addEventListener('click', () => formatDoc('justifyFull'));
        unorderedListBtn.addEventListener('click', () => formatDoc('insertUnorderedList'));
        orderedListBtn.addEventListener('click', () => formatDoc('insertOrderedList'));

        insertImageBtn.addEventListener('click', showInsertImageModal);
        insertLinkBtn.addEventListener('click', showInsertLinkModal);

        window.onload = function() {
            initializeIframe();
            openTab('file');
        };
    </script>
</body>
</html>
