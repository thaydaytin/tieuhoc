<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tr√≤ ch∆°i t√¨m ƒë√°p √°n - Th·∫ßy D·∫°y Tin</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background-color: #f0f8ff;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 5px 40px; background-color: #42a5f5; border-bottom: 4px solid #1e88e5;
    }
    .logo img { height: 100px; }
    nav a {
      margin-left: 25px; text-decoration: none;
      font-weight: 900; font-size: 1.2rem;
      color: white;
    }
    .container {
      margin: 20px auto;
      max-width: 90%;
    }
    #matrix {
      display: grid;
      grid-template-columns: repeat(32, 20px);
      grid-gap: 2px;
      justify-content: center;
      margin: 10px auto;
    }
    .cell {
      width: 20px;
      height: 20px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      background-color: white;
      user-select: none;
    }
    .cell.highlight {
      background-color: yellow;
    }
    #question {
      font-size: 18px;
      margin: 10px;
    }
    #timer, #scoreDisplay {
      font-size: 16px;
      font-weight: bold;
      margin: 5px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
    footer {
      margin-top: 30px;
      padding: 15px;
      background-color: #42a5f5;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><a href="../../index.html"><img src="../../logo.png" alt="Logo"></a></div>
    <nav>
      <a href="../../index.html">Trang ch·ªß</a>
      <a href="../../thoikhoabieu.html">Th·ªùi Kh√≥a Bi·ªÉu</a>
      <a href="../../gocgiaitri.html">G√≥c Gi·∫£i Tr√≠</a>
      <a href="../../gocthongtin.html">G√≥c Th√¥ng Tin</a>
    </nav>
  </header>

  <div class="container">
    <h2>üîç T√¨m ƒë√°p √°n ƒë√∫ng trong ma tr·∫≠n</h2>
    <input type="text" id="studentName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" style="padding:10px;width:80%">
    <br><br>
    <div id="question">ƒêang t·∫£i...</div>
    <div id="matrix"></div>
    <div id="timer">‚è±Ô∏è 30s</div>
    <div id="scoreDisplay">ƒêi·ªÉm: 0</div>
    <button onclick="startGame()">B·∫Øt ƒë·∫ßu</button>
  </div>

  <footer>Th·∫ßy D·∫°y Tin - 2025</footer>

  <script>
    const matrixSize = 32;
    let matrix = [];
    let questions = [];
    let current = 0;
    let timer, timeLeft = 30;
    let totalScore = 0;
    let answerCoords = [];

    const getParam = key => new URLSearchParams(location.search).get(key);
    const jsonURL = getParam('json');
    const tuan = getParam('tuan');
    const ngaybd = new Date(getParam('ngaybd'));
    const ngaykt = new Date(getParam('ngaykt'));
    const finalURL = decodeURIComponent(jsonURL);

    fetch(finalURL)
      .then(res => res.json())
      .then(data => { questions = data; document.getElementById("question").innerText = 'ƒê√£ s·∫µn s√†ng!'; })
      .catch(err => { document.getElementById("question").innerText = 'L·ªói t·∫£i d·ªØ li·ªáu!'; });

    function randomChar() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      return chars[Math.floor(Math.random() * chars.length)];
    }

    function generateMatrix(answer) {
      matrix = Array(matrixSize).fill().map(() => Array(matrixSize).fill().map(randomChar));
      let direction = Math.floor(Math.random() * 3);
      let row, col;

      if (direction === 0) {
        row = Math.floor(Math.random() * matrixSize);
        col = Math.floor(Math.random() * (matrixSize - answer.length));
        for (let i = 0; i < answer.length; i++) matrix[row][col + i] = answer[i];
        answerCoords = Array.from({ length: answer.length }, (_, i) => [row, col + i]);
      } else if (direction === 1) {
        row = Math.floor(Math.random() * (matrixSize - answer.length));
        col = Math.floor(Math.random() * matrixSize);
        for (let i = 0; i < answer.length; i++) matrix[row + i][col] = answer[i];
        answerCoords = Array.from({ length: answer.length }, (_, i) => [row + i, col]);
      } else {
        row = Math.floor(Math.random() * (matrixSize - answer.length));
        col = Math.floor(Math.random() * (matrixSize - answer.length));
        for (let i = 0; i < answer.length; i++) matrix[row + i][col + i] = answer[i];
        answerCoords = Array.from({ length: answer.length }, (_, i) => [row + i, col + i]);
      }
    }

    function renderMatrix() {
      const container = document.getElementById("matrix");
      container.innerHTML = '';
      for (let r = 0; r < matrixSize; r++) {
        for (let c = 0; c < matrixSize; c++) {
          let cell = document.createElement("div");
          cell.className = "cell";
          cell.innerText = matrix[r][c];
          container.appendChild(cell);
        }
      }
    }

    function showQuestion() {
      if (current >= questions.length) {
        sendToSheet();
        alert("üéâ B·∫°n ƒë√£ ho√†n th√†nh!");
        return;
      }
      const q = questions[current];
      document.getElementById("question").innerText = `üëâ ${q.question}`;
      generateMatrix(q.choices[q.answer]);
      renderMatrix();
      timeLeft = 30;
      document.getElementById("timer").innerText = `‚è±Ô∏è ${timeLeft}s`;
      totalScore = 10;
      document.getElementById("scoreDisplay").innerText = `ƒêi·ªÉm: ${totalScore}`;
      timer = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
      timeLeft--;
      document.getElementById("timer").innerText = `‚è±Ô∏è ${timeLeft}s`;
      if (timeLeft % 3 === 0) totalScore = Math.max(0, totalScore - 1);
      document.getElementById("scoreDisplay").innerText = `ƒêi·ªÉm: ${totalScore}`;
      if (timeLeft <= 0) {
        clearInterval(timer);
        current++;
        showQuestion();
      }
    }

    function startGame() {
      const now = new Date();
      if (now < ngaybd || now > ngaykt) {
        alert("‚õî Game ch·ªâ ho·∫°t ƒë·ªông trong kho·∫£ng th·ªùi gian quy ƒë·ªãnh!");
        return;
      }
      const student = document.getElementById("studentName").value.trim();
      if (student === "") {
        alert("Vui l√≤ng nh·∫≠p t√™n!");
        return;
      }
      current = 0;
      showQuestion();
    }

    function sendToSheet() {
  const name = document.getElementById("studentName").value.trim();
  const tuan = getParam("tuan");
  const ngaybdStr = getParam("ngaybd");
  const ngayktStr = getParam("ngaykt");

  if (!ngaybdStr || !ngayktStr) {
    console.log("Thi·∫øu tham s·ªë ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c!");
    return;
  }

  const ngaybd = new Date(ngaybdStr);
  const ngaykt = new Date(ngayktStr);
  const now = new Date();

  if (now >= ngaybd && now <= ngaykt) {
    fetch('https://script.google.com/macros/s/AKfycbzgUqhbFgVKUv5COoC-JIb3tvfjCYvvdKqBiZ47VzgdZXt-oQrxFWGGK-XZfF8y9duZ/exec', {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        name: name,
        score: totalScore,
        tuan: tuan,
        timestamp: now.toISOString()
      })
    });
  } else {
    console.log("Kh√¥ng g·ª≠i: Ngo√†i th·ªùi gian h·ª£p l·ªá.");
  }
}

  </script>
</body>
</html>
