<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.png" type="image/png">
  <title>Qu·∫£n l√Ω l·ªõp h·ªçc</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      text-align: center;
      padding: 50px;
    }
    #loginBox, #classManager {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 600px;
      margin: auto;
    }
    input[type=password], select {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: visible;
    }
    button:active {
      transform: scale(0.9);
      transition: transform 0.1s;
    }
    #error { color: red; margin-top: 10px; }
    .student {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    .name { flex: 1; text-align: left; }
    .like, .dislike { margin-left: 10px; cursor: pointer; font-size: 16px; }
    .effect {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      animation: popUp 1s forwards;
    }
    .effect.plus { color: green; }
    .effect.minus { color: red; }
    @keyframes popUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }
	/* --- Popup v√≤ng quay --- */
	.wheel-popup {
	  position: fixed;
	  top: 0; left: 0;
	  width: 100vw; height: 100vh;
	  background: rgba(0,0,0,0.7);
	  display: none;
	  align-items: center;
	  justify-content: center;
	  flex-direction: column;
	  z-index: 9999;
	}
	.wheel-content {
	  background: white;
	  border-radius: 16px;
	  padding: 20px;
	  text-align: center;
	  box-shadow: 0 0 30px rgba(0,0,0,0.4);
	  animation: fadeIn 0.3s ease-in-out;
	}
	@keyframes fadeIn {
	  from { opacity: 0; transform: scale(0.8); }
	  to { opacity: 1; transform: scale(1); }
	}
	#wheelCanvas {
	  border-radius: 50%;
	  border: 6px solid #1976d2;
	  background: #e3f2fd;
	  cursor: pointer;
	}

	/* --- Popup t√™n h·ªçc sinh tr√∫ng --- */
	.winner-popup {
	  position: fixed;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%);
	  font-size: 48px;
	  font-weight: bold;
	  color: #fff;
	  background: rgba(46, 125, 50, 0.9);
	  padding: 30px 60px;
	  border-radius: 20px;
	  display: none;
	  z-index: 10000;
	  animation: blink 1s infinite alternate;
	}
	@keyframes blink {
	  from { opacity: 1; transform: translate(-50%, -50%) scale(1); }
	  to { opacity: 0.6; transform: translate(-50%, -50%) scale(1.05); }
	}
	#fireworksCanvas {
	  position: absolute;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  pointer-events: none; /* kh√¥ng ·∫£nh h∆∞·ªüng t·ªõi chu·ªôt */
	  z-index: 0;
	}
	
	/* --- Popup ƒë·ªìng h·ªì --- */
	.timer-popup {
	  position: fixed;
	  top: 0; left: 0;
	  width: 100vw; height: 100vh;
	  background: rgba(0,0,0,0.6);
	  display: none;
	  align-items: center;
	  justify-content: center;
	  flex-direction: column;
	  z-index: 9999;
	}

	.timer-content {
	  background: linear-gradient(135deg, #42a5f5, #7e57c2, #26c6da, #ef5350);
	  background-size: 400% 400%;
	  animation: gradientMove 6s ease infinite;
	  color: white;
	  border-radius: 20px;
	  padding: 30px;
	  text-align: center;
	  box-shadow: 0 0 20px rgba(0,0,0,0.3);
	}

	@keyframes gradientMove {
	  0% { background-position: 0% 50%; }
	  50% { background-position: 100% 50%; }
	  100% { background-position: 0% 50%; }
	}

	.timer-display {
	  font-size: 80px;
	  font-weight: bold;
	  margin: 20px 0;
	  text-shadow: 2px 2px 8px rgba(0,0,0,0.4);
	}

	.timer-buttons button {
	  margin: 8px;
	  padding: 10px 20px;
	  border: none;
	  background: #fff;
	  color: #333;
	  border-radius: 8px;
	  cursor: pointer;
	  font-weight: bold;
	  transition: transform 0.2s;
	}
	.timer-buttons button:hover {
	  transform: scale(1.05);
	}

	/* --- Popup h·∫øt th·ªùi gian --- */
	.timeout-popup {
	  position: fixed;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%);
	  background: rgba(255, 64, 129, 0.95);
	  color: white;
	  font-size: 48px;
	  font-weight: bold;
	  padding: 40px 80px;
	  border-radius: 20px;
	  display: none;
	  z-index: 10000;
	  animation: blinkTimeout 1s infinite alternate;
	}
	@keyframes blinkTimeout {
	  from { opacity: 1; }
	  to { opacity: 0.5; }
	}
	
	/* --- V√≤ng tr√≤n ti·∫øn tr√¨nh --- */
	.timer-ring {
	  position: relative;
	  width: 220px;
	  height: 220px;
	  margin: auto;
	}
	.progress-ring {
	  transform: rotate(-90deg);
	}
	.progress-ring__circle {
	  stroke-dasharray: 628; /* 2 * PI * 100 (b√°n k√≠nh) */
	  stroke-dashoffset: 0;
	  transition: stroke-dashoffset 1s linear, stroke 1s;
	  stroke-linecap: round;
	  filter: drop-shadow(0 0 6px rgba(255,255,255,0.8));
	}
	.progress-ring__background {
	  stroke-linecap: round;
	}
	.timer-display {
	  position: absolute;
	  top: 50%;
	  left: 50%;
	  transform: translate(-50%, -50%);
	  font-size: 72px;
	  font-weight: bold;
	  color: #fff;
	  text-shadow: 0 0 10px rgba(0,0,0,0.5);
	}


  </style>
</head>
<body>
  <div id="loginBox">
    <h2>üîê Nh·∫≠p m·∫≠t kh·∫©u</h2>
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="checkPassword()">ƒêƒÉng nh·∫≠p</button>
    <div id="error"></div>
  </div>

  <div id="classManager" style="display:none;">
    <h2>üìö Trang qu·∫£n l√Ω l·ªõp h·ªçc</h2>
    <label for="classSelect">Ch·ªçn l·ªõp: </label>
    <select id="classSelect" onchange="loadStudents()">
      <option value="">-- Ch·ªçn l·ªõp --</option>
      <option value="3A">3A</option>
      <option value="3B">3B</option>
      <option value="3C">3C</option>
      <option value="4A">4A</option>
      <option value="4B">4B</option>
      <option value="4C">4C</option>
      <option value="5A">5A</option>
      <option value="5B1">5B1</option>
      <option value="5B2">5B2</option>
      <option value="5C">5C</option>
    </select>
    <br>
    <button onclick="copyStudents()">üìã Copy danh s√°ch h·ªçc sinh</button>
	<button onclick="openWheel()">üéØ G·ªçi T√™n HS ng·∫´u nhi√™n</button>
	<button onclick="openTimer()">‚è∞ ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c</button>
    <div id="studentList"></div>
	<!-- Popup v√≤ng quay h·ªçc sinh -->
	<div id="wheelPopup" class="wheel-popup">
	  <canvas id="fireworksCanvas"></canvas> <!-- Canvas ph√°o hoa -->
	  <div class="wheel-content">
		<canvas id="wheelCanvas" width="600" height="600"></canvas>
		<div style="margin-top:20px;">
		  <button onclick="spinWheel()">üé° Quay</button>
		  <button onclick="closeWheel()">‚úñ ƒê√≥ng</button>
		</div>
	  </div>
	  <div id="winnerPopup" class="winner-popup"></div>
	</div>
	
	<!-- Popup ƒë·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c -->
	<div id="timerPopup" class="timer-popup">
	  <div class="timer-content">
		<h2>‚è≥ ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c</h2>
		<div class="timer-ring">
		  <svg class="progress-ring" width="220" height="220">
			<circle class="progress-ring__background" stroke="#ffffff44" stroke-width="10" fill="transparent" r="100" cx="110" cy="110"/>
			<circle class="progress-ring__circle" stroke="#fff" stroke-width="10" fill="transparent" r="100" cx="110" cy="110"/>
		  </svg>
		  <div class="timer-display" id="timerDisplay">05:00</div>
		</div>

		<div style="margin-top:15px;">
		  <label>Ph√∫t: <input type="number" id="minutesInput" value="5" min="0" style="width:60px;"></label>
		  <label>Gi√¢y: <input type="number" id="secondsInput" value="0" min="0" max="59" style="width:60px;"></label>
		</div>
		<div class="timer-buttons">
		  <button onclick="startTimer()">‚ñ∂ B·∫Øt ƒë·∫ßu</button>
		  <button onclick="pauseTimer()">‚è∏ T·∫°m d·ª´ng</button>
		  <button onclick="resetTimer()">üîÑ ƒê·∫∑t l·∫°i</button>
		  <button onclick="closeTimer()">‚úñ ƒê√≥ng</button>
		</div>
	  </div>

	  <!-- Popup b√°o h·∫øt gi·ªù -->
	  <div id="timeoutPopup" class="timeout-popup">
		‚è∞ H·∫øt th·ªùi gian!
	  </div>
	</div>


  </div>

  <script>
    // ---------------- M·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p ----------------
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function checkPassword() {
      const password = document.getElementById("password").value;
      const enteredHash = await sha256(password);

      const response = await fetch("pw.json");
      const data = await response.json();
      const correctHash = data.hash;

      if (enteredHash === correctHash) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("classManager").style.display = "block";
      } else {
        document.getElementById("error").innerText = "‚ùå M·∫≠t kh·∫©u sai!";
      }
    }

    // ---------------- Qu·∫£n l√Ω l·ªõp h·ªçc ----------------
    const scriptUrl = "https://script.google.com/macros/s/AKfycbz-hJBaS4uxYfSW3oEmYnDBlsXl-U0HdPSvgZTNWp-yMwx6nCjR6wyOOPvHyRWKSRhwzw/exec"; // Thay b·∫±ng URL Apps Script

    async function loadStudents() {
      const className = document.getElementById("classSelect").value;
      if (!className) {
        document.getElementById("studentList").innerHTML = "";
        return;
      }

      let res = await fetch(`${scriptUrl}?class=${className}`);
      let data = await res.json();
      let students = data.slice(1); // b·ªè d√≤ng ti√™u ƒë·ªÅ

      let html = `<h3>L·ªõp ${className}</h3>`;
      students.forEach(s => {
        html += `
          <div class="student">
            <div class="name">${s[1]}</div>
            <button class="like" onclick="updatePoint('${className}','${s[0]}','like', this)">üëç</button>
            <button class="dislike" onclick="updatePoint('${className}','${s[0]}','dislike', this)">üëé</button>
          </div>
        `;
      });
      document.getElementById("studentList").innerHTML = html;
    }

    // Hi·ªáu ·ª©ng v√† c·∫≠p nh·∫≠t ƒëi·ªÉm
    async function updatePoint(className, id, action, el) {
      const parent = el.parentElement;
      const effect = document.createElement("div");
      effect.className = action === "like" ? "effect plus" : "effect minus";
      effect.textContent = action === "like" ? "+1" : "-1";

      // ƒê·∫∑t hi·ªáu ·ª©ng ph√≠a tr√™n n√∫t
      const rect = el.getBoundingClientRect();
      effect.style.left = el.offsetLeft + el.offsetWidth / 2 + "px";
      effect.style.top = "-5px";
      parent.appendChild(effect);
      setTimeout(() => effect.remove(), 1000);

      await fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({ id, action, class: className })
      });

      loadStudents();
    }

    // ---------------- Copy danh s√°ch h·ªçc sinh ----------------
		async function copyStudents() {
	  const className = document.getElementById("classSelect").value;
	  if (!className) {
		alert("Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!");
		return;
	  }

	  let res = await fetch(`${scriptUrl}?class=${className}`);
	  let data = await res.json();
	  let students = data.slice(1);

	  // T·∫°o danh s√°ch v·ªõi m·ªói h·ªçc sinh 1 d√≤ng ri√™ng (Excel hi·ªÉu ƒë∆∞·ª£c)
	  let listText = students.map(s => s[1]).join("\r\n"); // d√πng \r\n ƒë·ªÉ Excel t√°ch h√†ng

	  try {
		await navigator.clipboard.writeText(listText);
		alert("‚úÖ ƒê√£ copy danh s√°ch l·ªõp " + className + " ‚Äî d√°n th·∫≥ng v√†o Excel ƒë∆∞·ª£c!");
	  } catch (err) {
		alert("‚ùå Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông, vui l√≤ng copy th·ªß c√¥ng.");
	  }
	}
			// ---------------- V√≤ng quay h·ªçc sinh c√≥ √¢m thanh + l·ª±c quay ng·∫´u nhi√™n ----------------
	let wheelCanvas, ctx, studentsForWheel = [], startAngle = 0, arc = 0, spinTimeout = null;
	let spinAngleStart = 0, spinTime = 0, spinTimeTotal = 0;
	let audioSpin = null;

	function openWheel() {
	  const students = document.querySelectorAll(".student .name");
	  if (students.length === 0) {
		alert("Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!");
		return;
	  }

	  studentsForWheel = Array.from(students).map(s => s.textContent);
	  arc = Math.PI * 2 / studentsForWheel.length;

	  document.getElementById("wheelPopup").style.display = "flex";
	  document.getElementById("winnerPopup").style.display = "none";

	  wheelCanvas = document.getElementById("wheelCanvas");
	  ctx = wheelCanvas.getContext("2d");
	  drawWheel();
	}

	function closeWheel() {
	  document.getElementById("wheelPopup").style.display = "none";
	  document.getElementById("winnerPopup").style.display = "none";
	  clearTimeout(spinTimeout);
	  if (audioSpin) audioSpin.pause();
	}

	function drawWheel() {
	  const cx = 300, cy = 300;
	  const outsideRadius = 280;
	  const insideRadius = 50;
	  const textRadius = 200;

	  ctx.clearRect(0, 0, 600, 600);

	  for (let i = 0; i < studentsForWheel.length; i++) {
		const angle = startAngle + i * arc;
		const hue = (i * 360 / studentsForWheel.length);
		ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;

		ctx.beginPath();
		ctx.arc(cx, cy, outsideRadius, angle, angle + arc, false);
		ctx.arc(cx, cy, insideRadius, angle + arc, angle, true);
		ctx.fill();

		ctx.save();
		ctx.fillStyle = "white";
		ctx.translate(
		  cx + Math.cos(angle + arc / 2) * textRadius,
		  cy + Math.sin(angle + arc / 2) * textRadius
		);
		ctx.rotate(angle + arc / 2);
		ctx.textAlign = "center";
		ctx.font = "bold 18px Arial";
		ctx.fillText(studentsForWheel[i], 0, 0);
		ctx.restore();
	  }

	  // M≈©i t√™n ch·ªâ ƒë·ªãnh
	  ctx.fillStyle = "#e53935";
	  ctx.beginPath();
	  ctx.moveTo(cx - 20, cy - outsideRadius - 20);
	  ctx.lineTo(cx + 20, cy - outsideRadius - 20);
	  ctx.lineTo(cx, cy - outsideRadius + 10);
	  ctx.closePath();
	  ctx.fill();
	}

	function spinWheel() {
	  if (!audioSpin) {
		audioSpin = new Audio("sound/vongquay.mp3"); // üîä File √¢m thanh quay
	  }
	  audioSpin.currentTime = 0;
	  audioSpin.play();

	  // üéØ T·ªëc ƒë·ªô kh·ªüi ƒë·∫ßu ng·∫´u nhi√™n (tƒÉng/gi·∫£m nh·∫π)
	  // V√≠ d·ª• dao ƒë·ªông trong kho·∫£ng t·ª´ 15 ƒë·∫øn 35 ƒë·ªô m·ªói frame
	  spinAngleStart = Math.random() * 20 + 15;

	  spinTime = 0;
	  spinTimeTotal = 6000; // quay 6 gi√¢y
	  document.getElementById("winnerPopup").style.display = "none";
	  rotateWheel();
	}

	function rotateWheel() {
	  const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
	  startAngle += (spinAngle * Math.PI / 180);
	  drawWheel();

	  spinTime += 30;
	  if (spinTime >= spinTimeTotal) {
		stopRotateWheel();
		return;
	  }
	  spinTimeout = setTimeout(rotateWheel, 30);
	}

	function stopRotateWheel() {
	  clearTimeout(spinTimeout);
	  if (audioSpin) audioSpin.pause();

	  const degrees = startAngle * 180 / Math.PI + 90;
	  const arcd = arc * 180 / Math.PI;
	  const index = Math.floor((360 - (degrees % 360)) / arcd) % studentsForWheel.length;
	  const winner = studentsForWheel[index];

	  const popup = document.getElementById("winnerPopup");
	  popup.textContent = "üéâ " + winner + " üéâ";
	  popup.style.display = "block";

	  triggerFireworks(); // G·ªçi hi·ªáu ·ª©ng ph√°o hoa
	}

	function easeOut(t, b, c, d) {
	  const ts = (t /= d) * t;
	  const tc = ts * t;
	  return b + c * (tc + -3 * ts + 3 * t);
	}


	// ---------------- Hi·ªáu ·ª©ng ph√°o hoa khi tr√∫ng th∆∞·ªüng ----------------
	let fireworksCanvas = document.getElementById("fireworksCanvas");
	let fCtx = fireworksCanvas.getContext("2d");
	let fireworks = [];

	function resizeFireworks() {
	  fireworksCanvas.width = window.innerWidth;
	  fireworksCanvas.height = window.innerHeight;
	}
	window.addEventListener("resize", resizeFireworks);
	resizeFireworks();

	function createFirework(x, y) {
	  const colors = ["#ff5252", "#ffca28", "#69f0ae", "#40c4ff", "#ea80fc"];
	  for (let i = 0; i < 30; i++) {
		fireworks.push({
		  x: x,
		  y: y,
		  radius: Math.random() * 3 + 2,
		  color: colors[Math.floor(Math.random() * colors.length)],
		  angle: Math.random() * Math.PI * 2,
		  speed: Math.random() * 4 + 2,
		  life: 100
		});
	  }
	}

	function drawFireworks() {
	  fCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
	  for (let i = fireworks.length - 1; i >= 0; i--) {
		const f = fireworks[i];
		f.x += Math.cos(f.angle) * f.speed;
		f.y += Math.sin(f.angle) * f.speed;
		f.speed *= 0.98;
		f.life -= 2;
		fCtx.beginPath();
		fCtx.arc(f.x, f.y, f.radius, 0, Math.PI * 2);
		fCtx.fillStyle = f.color;
		fCtx.fill();
		if (f.life <= 0) fireworks.splice(i, 1);
	  }
	  requestAnimationFrame(drawFireworks);
	}
	drawFireworks();

	// G·ªçi khi h·ªçc sinh tr√∫ng
	function triggerFireworks() {
	  const cx = window.innerWidth / 2;
	  const cy = window.innerHeight / 2;
	  for (let i = 0; i < 5; i++) {
		setTimeout(() => createFirework(cx, cy), i * 200);
	  }
	}

	// ---------------- ƒê·ªìng h·ªì ƒë·∫øm ng∆∞·ª£c ----------------
	let ringCircle = null;
	let totalTime = 0;

	let timerInterval = null;
	let remainingSeconds = 0;
	let isPaused = false;
	let audioTimeout = null;

	function openTimer() {
	  document.getElementById("timerPopup").style.display = "flex";
	  document.getElementById("timeoutPopup").style.display = "none";
	  ringCircle = document.querySelector(".progress-ring__circle");
	  resetTimer();
	}

	function closeTimer() {
	  document.getElementById("timerPopup").style.display = "none";
	  clearInterval(timerInterval);
	  if (audioTimeout) audioTimeout.pause();
	}

	function updateDisplay() {
	  const display = document.getElementById("timerDisplay");
	  const minutes = Math.floor(remainingSeconds / 60);
	  const seconds = remainingSeconds % 60;
	  display.textContent = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
	}

	function startTimer() {
	  const minInput = parseInt(document.getElementById("minutesInput").value) || 0;
	  const secInput = parseInt(document.getElementById("secondsInput").value) || 0;

	  totalTime = minInput * 60 + secInput;
	  if (remainingSeconds === 0 || (!isPaused && remainingSeconds !== totalTime)) {
		remainingSeconds = totalTime;
	  }

	  if (remainingSeconds <= 0) {
		alert("Vui l√≤ng nh·∫≠p th·ªùi gian h·ª£p l·ªá!");
		return;
	  }

	  isPaused = false;
	  clearInterval(timerInterval);
	  timerInterval = setInterval(() => {
		if (!isPaused) {
		  remainingSeconds--;
		  updateDisplay();
		  updateRing();
		  if (remainingSeconds <= 0) {
			clearInterval(timerInterval);
			showTimeoutAlert();
		  }
		}
	  }, 1000);
	}

	function pauseTimer() {
	  isPaused = !isPaused;
	}

	function resetTimer() {
	  clearInterval(timerInterval);
	  isPaused = false;
	  const min = parseInt(document.getElementById("minutesInput").value) || 0;
	  const sec = parseInt(document.getElementById("secondsInput").value) || 0;
	  totalTime = min * 60 + sec;
	  remainingSeconds = totalTime;
	  updateDisplay();
	  updateRing();
	}

	function updateRing() {
	  if (!ringCircle || totalTime === 0) return;
	  const circumference = 2 * Math.PI * 100;
	  const offset = circumference - (remainingSeconds / totalTime) * circumference;
	  ringCircle.style.strokeDashoffset = offset;

	  // ƒë·ªïi m√†u theo ti·∫øn tr√¨nh
	  const percent = remainingSeconds / totalTime;
	  if (percent > 0.5) ringCircle.style.stroke = "#00e676";
	  else if (percent > 0.2) ringCircle.style.stroke = "#ffeb3b";
	  else ringCircle.style.stroke = "#ff1744";
	}
	
	function showTimeoutAlert() {
	  const timeoutPopup = document.getElementById("timeoutPopup");
	  timeoutPopup.style.display = "block";
	  
	  // Ph√°t √¢m thanh b√°o h·∫øt gi·ªù 
	  audioTimeout = new Audio("sound/alarm.mp3");
	  audioTimeout.play();

	  setTimeout(() => {
		timeoutPopup.style.display = "none";
	  }, 4000);
	}

  </script>
</body>
</html>
