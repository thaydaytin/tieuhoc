<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <link rel="icon" href="/favicon.png" type="image/png">
  <title>Qu·∫£n l√Ω l·ªõp h·ªçc</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      text-align: center;
      padding: 50px;
    }
    #loginBox, #classManager {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 600px;
      margin: auto;
    }
    input[type=password], select {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
    }
    button {
      padding: 10px 20px;
      border: none;
      background: #3498db;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      overflow: visible;
    }
    button:active {
      transform: scale(0.9);
      transition: transform 0.1s;
    }
    #error { color: red; margin-top: 10px; }
    .student {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
      position: relative;
    }
    .name { flex: 1; text-align: left; }
    .like, .dislike { margin-left: 10px; cursor: pointer; font-size: 16px; }
    .effect {
      position: absolute;
      font-size: 16px;
      font-weight: bold;
      opacity: 0;
      animation: popUp 1s forwards;
    }
    .effect.plus { color: green; }
    .effect.minus { color: red; }
    @keyframes popUp {
      0% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-30px); }
    }
	/* Popup v√≤ng quay */
	.wheel-popup {
	  position: fixed;
	  top: 0; left: 0;
	  width: 100vw;
	  height: 100vh;
	  background: rgba(0,0,0,0.7);
	  display: none;
	  align-items: center;
	  justify-content: center;
	  z-index: 9999;
	}
	.wheel-content {
	  background: white;
	  border-radius: 16px;
	  padding: 20px;
	  text-align: center;
	  box-shadow: 0 0 30px rgba(0,0,0,0.4);
	  animation: fadeIn 0.3s ease-in-out;
	}
	@keyframes fadeIn {
	  from { opacity: 0; transform: scale(0.8); }
	  to { opacity: 1; transform: scale(1); }
	}
	#wheelCanvas {
	  border-radius: 50%;
	  border: 6px solid #1976d2;
	  background: #e3f2fd;
	  cursor: pointer;
	}

  </style>
</head>
<body>
  <div id="loginBox">
    <h2>üîê Nh·∫≠p m·∫≠t kh·∫©u</h2>
    <input type="password" id="password" placeholder="M·∫≠t kh·∫©u">
    <button onclick="checkPassword()">ƒêƒÉng nh·∫≠p</button>
    <div id="error"></div>
  </div>

  <div id="classManager" style="display:none;">
    <h2>üìö Trang qu·∫£n l√Ω l·ªõp h·ªçc</h2>
    <label for="classSelect">Ch·ªçn l·ªõp: </label>
    <select id="classSelect" onchange="loadStudents()">
      <option value="">-- Ch·ªçn l·ªõp --</option>
      <option value="3A">3A</option>
      <option value="3B">3B</option>
      <option value="3C">3C</option>
      <option value="4A">4A</option>
      <option value="4B">4B</option>
      <option value="4C">4C</option>
      <option value="5A">5A</option>
      <option value="5B1">5B1</option>
      <option value="5B2">5B2</option>
      <option value="5C">5C</option>
    </select>
    <br>
    <button onclick="copyStudents()">üìã Copy danh s√°ch h·ªçc sinh</button>
	<button onclick="openWheel()">üéØ G·ªçi ng·∫´u nhi√™n</button>
    <div id="studentList"></div>
	<!-- Popup v√≤ng quay h·ªçc sinh -->
	<div id="wheelPopup" class="wheel-popup">
	  <div class="wheel-content">
		<canvas id="wheelCanvas" width="600" height="600"></canvas>
		<div style="margin-top:20px;">
		  <button onclick="spinWheel()">üé° Quay</button>
		  <button onclick="closeWheel()">‚úñ ƒê√≥ng</button>
		</div>
		<div id="winnerName" style="font-size:24px; font-weight:bold; margin-top:10px; color:#2e7d32;"></div>
	  </div>
	</div>


  </div>

  <script>
    // ---------------- M·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p ----------------
    async function sha256(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest("SHA-256", msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function checkPassword() {
      const password = document.getElementById("password").value;
      const enteredHash = await sha256(password);

      const response = await fetch("pw.json");
      const data = await response.json();
      const correctHash = data.hash;

      if (enteredHash === correctHash) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("classManager").style.display = "block";
      } else {
        document.getElementById("error").innerText = "‚ùå M·∫≠t kh·∫©u sai!";
      }
    }

    // ---------------- Qu·∫£n l√Ω l·ªõp h·ªçc ----------------
    const scriptUrl = "https://script.google.com/macros/s/AKfycbz-hJBaS4uxYfSW3oEmYnDBlsXl-U0HdPSvgZTNWp-yMwx6nCjR6wyOOPvHyRWKSRhwzw/exec"; // Thay b·∫±ng URL Apps Script

    async function loadStudents() {
      const className = document.getElementById("classSelect").value;
      if (!className) {
        document.getElementById("studentList").innerHTML = "";
        return;
      }

      let res = await fetch(`${scriptUrl}?class=${className}`);
      let data = await res.json();
      let students = data.slice(1); // b·ªè d√≤ng ti√™u ƒë·ªÅ

      let html = `<h3>L·ªõp ${className}</h3>`;
      students.forEach(s => {
        html += `
          <div class="student">
            <div class="name">${s[1]}</div>
            <button class="like" onclick="updatePoint('${className}','${s[0]}','like', this)">üëç</button>
            <button class="dislike" onclick="updatePoint('${className}','${s[0]}','dislike', this)">üëé</button>
          </div>
        `;
      });
      document.getElementById("studentList").innerHTML = html;
    }

    // Hi·ªáu ·ª©ng v√† c·∫≠p nh·∫≠t ƒëi·ªÉm
    async function updatePoint(className, id, action, el) {
      const parent = el.parentElement;
      const effect = document.createElement("div");
      effect.className = action === "like" ? "effect plus" : "effect minus";
      effect.textContent = action === "like" ? "+1" : "-1";

      // ƒê·∫∑t hi·ªáu ·ª©ng ph√≠a tr√™n n√∫t
      const rect = el.getBoundingClientRect();
      effect.style.left = el.offsetLeft + el.offsetWidth / 2 + "px";
      effect.style.top = "-5px";
      parent.appendChild(effect);
      setTimeout(() => effect.remove(), 1000);

      await fetch(scriptUrl, {
        method: "POST",
        body: JSON.stringify({ id, action, class: className })
      });

      loadStudents();
    }

    // ---------------- Copy danh s√°ch h·ªçc sinh ----------------
		async function copyStudents() {
	  const className = document.getElementById("classSelect").value;
	  if (!className) {
		alert("Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!");
		return;
	  }

	  let res = await fetch(`${scriptUrl}?class=${className}`);
	  let data = await res.json();
	  let students = data.slice(1);

	  // T·∫°o danh s√°ch v·ªõi m·ªói h·ªçc sinh 1 d√≤ng ri√™ng (Excel hi·ªÉu ƒë∆∞·ª£c)
	  let listText = students.map(s => s[1]).join("\r\n"); // d√πng \r\n ƒë·ªÉ Excel t√°ch h√†ng

	  try {
		await navigator.clipboard.writeText(listText);
		alert("‚úÖ ƒê√£ copy danh s√°ch l·ªõp " + className + " ‚Äî d√°n th·∫≥ng v√†o Excel ƒë∆∞·ª£c!");
	  } catch (err) {
		alert("‚ùå Kh√¥ng th·ªÉ copy t·ª± ƒë·ªông, vui l√≤ng copy th·ªß c√¥ng.");
	  }
	}
			// ---------------- V√≤ng quay h·ªçc sinh d·∫°ng popup ----------------
	let wheelCanvas, ctx, studentsForWheel = [], startAngle = 0, arc = 0, spinTimeout = null;
	let spinAngleStart = 0, spinTime = 0, spinTimeTotal = 0;

	function openWheel() {
	  const students = document.querySelectorAll(".student .name");
	  if (students.length === 0) {
		alert("Vui l√≤ng ch·ªçn l·ªõp tr∆∞·ªõc!");
		return;
	  }

	  studentsForWheel = Array.from(students).map(s => s.textContent);
	  arc = Math.PI * 2 / studentsForWheel.length;

	  document.getElementById("wheelPopup").style.display = "flex";
	  document.getElementById("winnerName").textContent = "";

	  wheelCanvas = document.getElementById("wheelCanvas");
	  ctx = wheelCanvas.getContext("2d");
	  drawWheel();
	}

	function closeWheel() {
	  document.getElementById("wheelPopup").style.display = "none";
	  clearTimeout(spinTimeout);
	}

	function drawWheel() {
	  const outsideRadius = 280;
	  const textRadius = 200;
	  const insideRadius = 50;
	  const cx = 300, cy = 300;
	  ctx.clearRect(0, 0, 600, 600);

	  for (let i = 0; i < studentsForWheel.length; i++) {
		const angle = startAngle + i * arc;

		// m√†u ng·∫´u nhi√™n t∆∞∆°i s√°ng
		const hue = (i * 360 / studentsForWheel.length);
		ctx.fillStyle = `hsl(${hue}, 80%, 60%)`;

		ctx.beginPath();
		ctx.arc(cx, cy, outsideRadius, angle, angle + arc, false);
		ctx.arc(cx, cy, insideRadius, angle + arc, angle, true);
		ctx.fill();

		ctx.save();
		ctx.fillStyle = "white";
		ctx.translate(
		  cx + Math.cos(angle + arc / 2) * textRadius,
		  cy + Math.sin(angle + arc / 2) * textRadius
		);
		ctx.rotate(angle + arc / 2);
		ctx.textAlign = "center";
		ctx.font = "bold 16px Arial";
		// vi·∫øt t·ª´ t√¢m ra ngo√†i
		ctx.fillText(studentsForWheel[i], 0, 0);
		ctx.restore();
	  }

	  // V·∫Ω m≈©i t√™n ch·ªâ ƒë·ªãnh
	  ctx.fillStyle = "#e53935";
	  ctx.beginPath();
	  ctx.moveTo(cx - 15, cy - outsideRadius - 10);
	  ctx.lineTo(cx + 15, cy - outsideRadius - 10);
	  ctx.lineTo(cx, cy - outsideRadius + 20);
	  ctx.closePath();
	  ctx.fill();
	}

	function rotateWheel() {
	  const spinAngle = spinAngleStart - easeOut(spinTime, 0, spinAngleStart, spinTimeTotal);
	  startAngle += (spinAngle * Math.PI / 180);
	  drawWheel();

	  spinTime += 30;
	  if (spinTime >= spinTimeTotal) {
		stopRotateWheel();
		return;
	  }
	  spinTimeout = setTimeout(rotateWheel, 30);
	}

	function stopRotateWheel() {
	  clearTimeout(spinTimeout);
	  const degrees = startAngle * 180 / Math.PI + 90;
	  const arcd = arc * 180 / Math.PI;
	  const index = Math.floor((360 - (degrees % 360)) / arcd) % studentsForWheel.length;
	  const winner = studentsForWheel[index];

	  document.getElementById("winnerName").textContent = "üéâ H·ªçc sinh ƒë∆∞·ª£c g·ªçi l√†: " + winner;
	}

	function easeOut(t, b, c, d) {
	  const ts = (t /= d) * t;
	  const tc = ts * t;
	  return b + c * (tc + -3 * ts + 3 * t);
	}

	function spinWheel() {
	  spinAngleStart = Math.random() * 10 + 20;
	  spinTime = 0;
	  spinTimeTotal = 5000; // quay 5 gi√¢y
	  rotateWheel();
	}


  </script>
</body>
</html>
