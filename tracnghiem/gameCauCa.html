<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Th·∫ßy D·∫°y Tin - Tr√≤ ch∆°i C√¢u C√° Tr·∫Øc Nghi·ªám</title>

  <!-- Fonts gi·ªëng gametracnghiem.html -->
  <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- Copy/Adapted styling from gametracnghiem.html, with container for canvas game --- */
    html, body { height:100%; margin:0; padding:0; box-sizing:border-box; font-family:'Nunito',sans-serif; background: linear-gradient(to bottom right, #87CEEB, #FFFACD); color:#333; display:flex; flex-direction:column; }
    *, *::before, *::after { box-sizing:inherit; }

    header {
      display:flex; justify-content:space-between; align-items:center;
      padding:2px 40px; background-color:#42a5f5; border-bottom:4px solid #1e88e5; box-shadow:0 4px 8px rgba(0,0,0,0.2); width:100%;
    }
    .logo img { height:100px; border-radius:0; border:none; }
    nav a { margin-left:25px; text-decoration:none; font-weight:900; font-size:1.2rem; color:white; transition:all .3s; text-shadow:1px 1px 2px rgba(0,0,0,.3); }
    nav a:hover { color:#FFD700; transform:scale(1.1); }

    .wrapper { flex:1; display:flex; flex-direction:column; align-items:center; padding:20px; width:100%; }
    .container { background-color: rgba(255,255,255,0.95); max-width: 900px; width:100%; margin:20px auto; padding:24px; border-radius:20px; text-align:center; box-shadow:0 10px 20px rgba(0,0,0,0.3); border:5px solid #90EE90; position:relative; overflow:hidden; }

    h2 { font-family:'Patrick Hand',sans-serif; color:#FF6347; font-size:2.4rem; margin:0 0 12px 0; }
    input[type="text"] { padding:12px 16px; width:70%; border:3px solid #ADD8E6; border-radius:12px; font-size:1.1rem; text-align:center; }

    .controls { margin-top:12px; display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }

    button { font-family:'Patrick Hand',sans-serif; font-weight:700; font-size:1.1rem; padding:10px 18px; border-radius:18px; cursor:pointer; border:none; background: linear-gradient(to right,#4CAF50,#8BC34A); color:white; box-shadow:0 5px 10px rgba(0,0,0,0.2); transition:all .2s; }
    button:hover { transform:translateY(-3px); }
    .btn-secondary { background: linear-gradient(to right,#64b5f6,#90caf9); color:white; }
    .btn-danger { background: linear-gradient(to right,#ef4444,#f97316); color:white; }

    /* Game layout */
    .game-area { display:flex; gap:18px; align-items:flex-start; justify-content:center; flex-wrap:wrap; }
    .stats { width: 260px; min-width:220px; text-align:left; }
    .stat-card { background:#f8fafc; padding:12px; border-radius:10px; margin-bottom:10px; border:1px solid #e6edf3; }
    .stat-card p { margin:6px 0; font-weight:700; }
    #messageBox { background:#eef2ff; color:#3730a3; padding:10px; border-radius:8px; margin-top:8px; text-align:center; font-weight:600; }

    /* Canvas styling (keep GameCauCa visual) */
    #lakeCanvas { border:5px solid #0891b2; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.15); width:100%; max-width:560px; height:340px; background: linear-gradient(to bottom,#7dd3fc 0%,#38bdf8 100%); cursor:crosshair; }

    /* Quiz modal (overlay) */
    #quizModal { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index:9999; padding:20px; }
    #quizContent { background:white; border-radius:14px; padding:20px; max-width:640px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,0.25); }
    .quiz-option { display:block; width:100%; text-align:left; padding:12px 14px; margin:8px 0; border-radius:10px; border:2px solid #e6edf3;color: #000;  background:#fff7ed; font-weight:700; cursor:pointer; }
    .quiz-option.correct { background:#7CFC00; border-color:#32CD32; color:#073; }
    .quiz-option.wrong { background:#FF6347; border-color:#DC143C; color:white; }

    /* Game Over / End screen modal smaller */
    #endModal { display:none; position:fixed; inset:0; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:9998; }
    #endContent { background:white; padding:28px; border-radius:14px; max-width:420px; width:96%; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.2); }

    footer { background-color:#64b5f6; color:white; text-align:center; padding:20px 10px; font-size:1rem; border-top:5px solid #1e88e5; box-shadow:0 -4px 8px rgba(0,0,0,0.2); width:100%; }
    footer p { margin:6px 0; font-weight:600; }

    /* Responsive */
    @media (max-width:900px) {
      .game-area { flex-direction:column; align-items:center; }
      .stats { width:90%; max-width:420px; order:2; }
      #lakeCanvas { max-width:90%; height:320px; }
    }
	@media (max-width: 768px) {
	  #lakeCanvas {
		max-width: 95%;
		height: 320px;
	  }
	}
  </style>
</head>
<body>
  <!-- Header (same layout/text as gametracnghiem.html) -->
  <header>
    <div class="logo">
      <!-- Image URL used as placeholder; replace with actual logo path -->
      <a href="../index.html"><img src="https://placehold.co/100x100/42a5f5/ffffff?text=Logo" alt="Logo Th·∫ßy D·∫°y Tin" style="height: 50px;"></a>
    </div>
    <nav>
      <a href="../index.html">Trang ch·ªß</a>
      <a href="../MoPhongPC/MoPhongPC.html" target="_blank" rel="noopener noreferrer">PC-M√¥ Ph·ªèng</a>
      <a href="../gocgiaitri.html">G√≥c Gi·∫£i Tr√≠</a>
      <a href="../gocthongtin.html">G√≥c Th√¥ng Tin</a>
    </nav>
  </header>

  <div class="wrapper">
    <!-- Start Screen: nh·∫≠p t√™n + n√∫t Start -->
    <div class="container" id="startScreen">
      <h2>üé£ Tr√≤ Ch∆°i C√¢u C√° H·ªçc T·∫≠p</h2>
      <p>Nh·∫≠p t√™n h·ªçc sinh v√† b·∫•m <strong>B·∫Øt ƒë·∫ßu</strong> ƒë·ªÉ th·∫£ c·∫ßn. Sau khi c√¢u ƒë∆∞·ª£c c√°, h√£y tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ ghi ƒëi·ªÉm.</p>
      <input type="text" id="studentName" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n" />
      <div class="controls">
        <button id="startBtn">B·∫Øt ƒë·∫ßu</button>
        <button id="howBtn" class="btn-secondary">H∆∞·ªõng d·∫´n</button>
      </div>
      <p id="loadingText" style="color:red; font-weight:bold; margin-top:10px;">‚è≥ ƒêang t·∫£i c√¢u h·ªèi...</p>
    </div>

    <!-- Game Screen -->
    <div class="container" id="gameScreen" style="display:none;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:10px;">
        <div>
          <h2 style="margin:0;">üé£ H·ªì C√¢u</h2>
          <p style="margin:4px 0 0 0; font-weight:600;">Th·∫£ c·∫ßn ƒë·ªÉ c√¢u. M·ªói l∆∞·ª£t th·∫£ t∆∞∆°ng ·ª©ng 1 l·∫ßn c√¢u (t·ªïng 10 l∆∞·ª£t).</p>
        </div>
        <div>
          <div style="display:flex; gap:8px; align-items:center;">
          </div>
        </div>
      </div>

      <div class="game-area">
        <!-- Canvas -->
        <div style="flex:1; min-width:320px; max-width:600px;">
          <canvas id="lakeCanvas" width="800" height="400"></canvas>
          <div id="messageBox">S·∫µn s√†ng c√¢u! B·∫°n c√≥ <span id="turnsLeft">10</span> l∆∞·ª£t.</div>
        </div>

        <!-- Stats -->
        <div class="stats">
          <div class="stat-card">
            <p>T√™n: <span id="studentDisplay">-</span></p>
            <p>T·ªïng ƒëi·ªÉm: <span id="totalScore">0</span></p>
            <p>C√° ƒë√£ c√¢u: <span id="fishCaught">0</span></p>
            <p>L∆∞·ª£t c√≤n l·∫°i: <span id="turnsLeftSmall">10</span></p>
          </div>

          <div class="stat-card">
            <p>Lo·∫°i c√° & ƒëi·ªÉm:</p>
            <ul style="margin:6px 0 0 18px;">
              <li>C√° nh·ªè ‚Äî 4 ƒëi·ªÉm</li>
              <li>C√° v·ª´a ‚Äî 8 ƒëi·ªÉm</li>
              <li>C√° l·ªõn ‚Äî 12 ƒëi·ªÉm</li>
            </ul>
          </div>

          <div class="stat-card">
            <p style="margin-bottom:6px;">Ghi ch√∫:</p>
            <p style="margin:0; font-size:0.95rem;">Khi c√¢u ƒë∆∞·ª£c c√°, c·ª≠a s·ªï h·ªèi ƒë√°p s·∫Ω xu·∫•t hi·ªán. Tr·∫£ l·ªùi ƒë√∫ng ƒë·ªÉ c·ªông ƒëi·ªÉm. Game k·∫øt th√∫c sau 10 l∆∞·ª£t.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- End Screen (shown inline when game over) -->
    <div class="container" id="endScreen" style="display:none;">
      <h2>üéâ K·∫øt th√∫c tr√≤ ch∆°i!</h2>
      <p id="finalScoreText" style="font-size:1.2rem; font-weight:800;"></p>
      <div class="controls">
        <button id="endReplayBtn">üîÅ Ch∆°i l·∫°i</button>
        <button id="endCompleteBtn" class="btn-danger">‚úÖ Ho√†n th√†nh & G·ª≠i</button>
      </div>
    </div>
  </div>

  <!-- Quiz Modal -->
  <div id="quizModal">
    <div id="quizContent">
      <h3 style="margin-top:0;">‚ùì C√¢u h·ªèi tr·∫Øc nghi·ªám</h3>
      <p id="quizQuestion" style="font-weight:700; font-size:1.1rem;"></p>
      <div id="quizOptions"></div>
      <p id="quizFeedback" style="font-weight:700; min-height:28px; margin-top:8px;"></p>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="quizNextBtn" style="display:none;">Ti·∫øp t·ª•c</button>
      </div>
    </div>
  </div>

  <!-- Small Notification Modal (replaces alert/confirm) -->
  <div id="endModal">
    <div id="endContent"></div>
  </div>

  <footer>
    <p>üåü C√πng nhau h·ªçc t·∫≠p th·∫≠t vui v√† s√°ng t·∫°o m·ªói ng√†y! üåü</p>
    <p>¬© 2025 - Trang web ƒë∆∞·ª£c x√¢y d·ª±ng d√†nh ri√™ng cho h·ªçc sinh Ti·ªÉu h·ªçc ‚ù§Ô∏è</p>
  </footer>

  <script>
  /*****************************************************************
   * GameCauCa_v2.html - C·∫¨P NH·∫¨T
   * - ƒê√É KH·∫ÆC PH·ª§C: L·ªói Canvas kh√¥ng hi·ªÉn th·ªã c√° khi m·ªõi load (v·∫•n ƒë·ªÅ offsetWidth=0).
   * - ƒê√É KH·∫ÆC PH·ª§C: L·ªói s·ª≠ d·ª•ng bi·∫øn `student` v√† `totalScore` sai t√™n khi g·ª≠i ƒëi·ªÉm.
   *****************************************************************/

  // -------------------- Config & State --------------------
  // S·ª≠ d·ª•ng URL Google Script c·ªßa b·∫°n.
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxy-3x5N1pmswuykwdjPGtB5qoOybiYBP4ycumyShkPoQFKQdbLQNjPZShQPVC8F240/exec";

  // Fish types like original GameCauCa
  const BASE_FISH_DATA = [
    { size: 'nh·ªè', score: 4, baseRadius: 12, maxRadius: 15, color: '#10b981' },
    { size: 'v·ª´a', score: 8, baseRadius: 18, maxRadius: 22, color: '#f59e0b' },
    { size: 'l·ªõn', score: 12, baseRadius: 24, maxRadius: 29, color: '#dc2626' },
  ];
  const FISH_COUNT = 15;
  const LARGE_FISH_ID = 0; // keep like original: fish id 0 is large

  // Game state
  let questions = []; // loaded from external JSON
  let studentName = '';
  let gameState = {
    score: 0,
    turnsLeft: 10,
    fishCaught: 0,
    currentFishScore: 0,
    isQuizzing: false,
    currentCaughtFish: null,
  };

  // Canvas & fish objects
  const canvas = document.getElementById('lakeCanvas');
  const ctx = canvas.getContext('2d');
  let fishes = [];
  let rod = { isCast:false, x:0, y:0, lureY:0, animationProgress:0, isPulling:false };

  // DOM refs
  const loadingText = document.getElementById('loadingText');
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const endScreen = document.getElementById('endScreen');
  const studentInput = document.getElementById('studentName');
  const studentDisplay = document.getElementById('studentDisplay');
  const totalScoreEl = document.getElementById('totalScore');
  const fishCaughtEl = document.getElementById('fishCaught');
  const turnsLeftEl = document.getElementById('turnsLeft');
  const turnsLeftSmallEl = document.getElementById('turnsLeftSmall');
  const messageBox = document.getElementById('messageBox');
  const finalScoreText = document.getElementById('finalScoreText');
  const endModal = document.getElementById('endModal');
  const endContent = document.getElementById('endContent');


  // Quiz modal elements
  const quizModal = document.getElementById('quizModal');
  const quizQuestionEl = document.getElementById('quizQuestion');
  const quizOptionsEl = document.getElementById('quizOptions');
  const quizFeedbackEl = document.getElementById('quizFeedback');
  const quizNextBtn = document.getElementById('quizNextBtn');

  // Buttons
  const startBtn = document.getElementById('startBtn');
  const howBtn = document.getElementById('howBtn');
  const endReplayBtn = document.getElementById('endReplayBtn');
  const endCompleteBtn = document.getElementById('endCompleteBtn');

  // -------------------- URL param helpers & load questions --------------------
  function getParam(key) {
    const url = new URL(window.location.href);
    return url.searchParams.get(key);
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // Load questions from JSON passed by ?json=
  const jsonURLParam = getParam('json');
  if (!jsonURLParam) {
    loadingText.innerText = "‚ùå Kh√¥ng c√≥ ƒë∆∞·ªùng d·∫´n d·ªØ li·ªáu c√¢u h·ªèi! Vui l√≤ng truy·ªÅn ?json=URL";
  } else {
    const finalURL = decodeURIComponent(jsonURLParam);
    fetch(finalURL)
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        // Expecting array of objects {question, choices, answer}
        questions = shuffleArray(data.slice()); // copy + shuffle
        loadingText.innerText = "‚úÖ C√¢u h·ªèi ƒë√£ s·∫µn s√†ng! Nh·∫≠p t√™n ƒë·ªÉ b·∫Øt ƒë·∫ßu.";
      })
      .catch(err => {
        console.error("L·ªói t·∫£i JSON:", err);
        loadingText.innerText = "‚ùå Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¢u h·ªèi. Ki·ªÉm tra URL JSON.";
      });
  }

  // -------------------- Fish class (adapted from original) --------------------
  class Fish {
    constructor(id) { this.id = id; this.reset(); }
    reset() {
      let fishType;
      let validTypes = [...BASE_FISH_DATA];
      if (this.id === LARGE_FISH_ID) {
        fishType = validTypes.find(f => f.size === 'l·ªõn');
      } else {
        validTypes = validTypes.filter(f => f.size !== 'l·ªõn');
        fishType = validTypes[Math.floor(Math.random() * validTypes.length)];
      }
      this.size = fishType.size;
      this.score = fishType.score;
      this.radius = fishType.baseRadius + Math.random() * (fishType.maxRadius - fishType.baseRadius);
      this.color = fishType.color;
      this.x = Math.random() * canvas.width;
      this.y = (Math.random() * (canvas.height - 50)) + 50;
      
      // --- START C·∫¨P NH·∫¨T T·ªêC ƒê·ªò: C√° nh·ªè b∆°i nhanh nh·∫•t, C√° l·ªõn b∆°i ch·∫≠m nh·∫•t ---
      // C√¥ng th·ª©c m·ªõi: Gi√° tr·ªã c√†ng l·ªõn (15) th√¨ t·ªëc ƒë·ªô c√†ng th·∫•p.
      // D√πng 3.5 l√†m base speed cao nh·∫•t, v√† tr·ª´ ƒëi 3.0 * (score/15)
      //const speedBase = 3.5 - (this.score / 12) * 3.0; 
		const speedBase = 4.5 - (12 / this.score ) ; 
      this.speed = speedBase + Math.random() * 0.5; // C·ªông th√™m m·ªôt ch√∫t ng·∫´u nhi√™n (0.0 ƒë·∫øn 0.5)
      // --- END C·∫¨P NH·∫¨T T·ªêC ƒê·ªò ---
      
      this.directionX = Math.random() > 0.5 ? 1 : -1;
      this.directionY = Math.random() > 0.5 ? 0.1 : -0.1;
      this.swimPhase = Math.random() * Math.PI * 2;
      this.isTargeted = false;
      this.isCaught = false;
    }
    update() {
      if (this.isCaught) return;
      if (this.isTargeted) {
        const dx = rod.x - this.x;
        const dy = rod.y - this.y;
        const angle = Math.atan2(dy, dx);
        const chaseSpeed = 5;
        this.x += Math.cos(angle) * chaseSpeed;
        this.y += Math.sin(angle) * chaseSpeed;
        this.directionX = dx > 0 ? 1 : -1;
        if (Math.hypot(dx, dy) < this.radius + 5) {
          this.isCaught = true; this.isTargeted = false; rod.isPulling = true;
        }
      } else {
        this.x += this.speed * this.directionX;
        this.swimPhase += 0.05;
        this.y += Math.sin(this.swimPhase) * this.directionY;
        if (this.x - this.radius < 0 || this.x + this.radius > canvas.width) { this.directionX *= -1; this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x)); }
        if (this.y - this.radius < 50 || this.y + this.radius > canvas.height) { this.directionY *= -1; this.y = Math.max(50 + this.radius, Math.min(canvas.height - this.radius, this.y)); }
      }
    }
    draw() {
      ctx.save(); ctx.translate(this.x, this.y);
      if (this.directionX < 0) ctx.scale(-1,1);
      if (this.isTargeted && !this.isCaught) { ctx.shadowColor='yellow'; ctx.shadowBlur=15; }
      ctx.beginPath(); ctx.ellipse(0,0,this.radius*1.5,this.radius,0,0,Math.PI*2); ctx.fillStyle=this.color; ctx.fill(); ctx.strokeStyle='#333'; ctx.lineWidth=1; ctx.stroke();
      ctx.beginPath(); ctx.arc(this.radius*0.8,0,this.radius*0.15,0,Math.PI*2); ctx.fillStyle='black'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(-this.radius*1.5,0); ctx.lineTo(-this.radius*1.5-(this.radius*0.8),-this.radius*0.7); ctx.lineTo(-this.radius*1.5-(this.radius*0.8),this.radius*0.7); ctx.closePath(); ctx.fillStyle=this.color; ctx.fill();
      ctx.restore();
    }
  }

  // -------------------- Init & animation --------------------
  
  // H√†m thi·∫øt l·∫≠p l·∫°i k√≠ch th∆∞·ªõc Canvas theo k√≠ch th∆∞·ªõc hi·ªÉn th·ªã
  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    // C·∫≠p nh·∫≠t l·∫°i v·ªã tr√≠ c√° n·∫øu c·∫ßn thi·∫øt (optional, nh∆∞ng an to√†n h∆°n)
    fishes.forEach(f => {
        f.x = Math.min(f.x, canvas.width - f.radius);
        f.y = Math.min(f.y, canvas.height - f.radius);
    });
  }

  function initGameObjects() {
    fishes = [];
    // KH√îNG g·ªçi resizeCanvas ·ªü ƒë√¢y. G·ªçi sau khi gameScreen ƒë√£ display: block
    for (let i=0;i<FISH_COUNT;i++) fishes.push(new Fish(i));
  }

  function drawEnvironment() {
    // Rocks
    const rocks = [{ x:100, y:canvas.height-20, radius:30, color:'#78716c' }, { x:canvas.width-150, y:canvas.height-30, radius:45, color:'#57534e' }];
    rocks.forEach(rock => { ctx.beginPath(); ctx.ellipse(rock.x, rock.y, rock.radius*1.5, rock.radius,0,0,Math.PI*2); ctx.fillStyle=rock.color; ctx.fill(); });
    const smallRocks = [{x:250,y:canvas.height-10,radius:8,color:'#a8a29e'},{x:400,y:canvas.height-15,radius:12,color:'#78716c'},{x:600,y:canvas.height-5,radius:5,color:'#a8a29e'}];
    smallRocks.forEach(r=>{ ctx.beginPath(); ctx.arc(r.x,r.y,r.radius,0,Math.PI*2); ctx.fillStyle=r.color; ctx.fill(); });
    // Moss
    ctx.strokeStyle='#059669'; ctx.lineWidth=3; ctx.lineCap='round';
    for (let i=0;i<5;i++){ ctx.beginPath(); ctx.moveTo(0, canvas.height-10 - i*5); ctx.bezierCurveTo(20, canvas.height-30 - i*10, 10, canvas.height-50 - i*15, 10 + Math.random()*10, canvas.height-70 - i*20); ctx.stroke(); }
    for (let i=0;i<5;i++){ ctx.beginPath(); ctx.moveTo(canvas.width, canvas.height-10 - i*5); ctx.bezierCurveTo(canvas.width-20, canvas.height-30 - i*10, canvas.width-10, canvas.height-50 - i*15, canvas.width - 10 - Math.random()*10, canvas.height-70 - i*20); ctx.stroke(); }
  }

  function drawWater() {
    ctx.fillStyle='rgba(255,255,255,0.08)';
    for (let i=0;i<5;i++) ctx.fillRect(0, i*80 + (Date.now()%5000)/50, canvas.width, 2);
  }

  function drawFishingRod() {
    if (!rod.isCast) return;
    const rodBaseX = canvas.width / 2;
    const rodBaseY = 0;
    ctx.beginPath(); ctx.moveTo(rodBaseX, rodBaseY); ctx.lineTo(rod.x, rod.lureY); ctx.strokeStyle='#333'; ctx.lineWidth=2; ctx.stroke();
    rod.animationProgress = (rod.animationProgress + 0.1) % (Math.PI*2);
    ctx.beginPath(); ctx.arc(rod.x + Math.sin(rod.animationProgress*5)*2, rod.lureY, 5, 0, Math.PI*2);
    ctx.fillStyle = rod.isPulling ? '#0d9488' : '#f87171'; ctx.fill();

    if (rod.isPulling) {
      rod.lureY -= 8;
      const caughtFish = fishes.find(f => f.isCaught);
      if (caughtFish) {
        caughtFish.x = rod.x + Math.sin(rod.animationProgress*5)*2;
        caughtFish.y = rod.lureY;
        gameState.currentCaughtFish = caughtFish;
      }
      if (rod.lureY <= 0) {
        rod.isCast = false; rod.isPulling = false;
        if (gameState.currentCaughtFish) {
          messageBox.textContent = `‚úÖ C√¢u ƒë∆∞·ª£c c√° ${gameState.currentCaughtFish.size} (${gameState.currentCaughtFish.score} ƒëi·ªÉm)! Tr·∫£ l·ªùi c√¢u h·ªèi.` ;
          gameState.currentFishScore = gameState.currentCaughtFish.score;
          // show quiz
          setTimeout(() => showQuizFromQuestions(gameState.currentCaughtFish.score), 300);
        } else {
          resetRodAndMessage("S·∫µn s√†ng c√¢u! B·∫°n c√≥ " + gameState.turnsLeft + " l∆∞·ª£t.");
        }
      }
    } else if (rod.lureY < rod.y) {
      rod.lureY += 5;
    } else if (rod.lureY >= rod.y && rod.isCast) {
      rod.lureY = rod.y;
      checkCatch();
    }
  }

  function animate() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawEnvironment();
    drawWater();
    fishes.forEach(f=>{ f.update(); f.draw(); });
    drawFishingRod();
    requestAnimationFrame(animate);
  }

  // -------------------- Casting & catching logic --------------------
  function resetRodAndMessage(msg) {
    rod.isCast = false; rod.isPulling = false;
    messageBox.textContent = msg;
    updateUI();
  }

  function handleCast(e) {
    if (rod.isCast || gameState.isQuizzing) { showMessage("B·∫°n ƒëang c√¢u ho·∫∑c ƒëang tr·∫£ l·ªùi quiz! H√£y ƒë·ª£i.", "warning"); return; }
    if (gameState.turnsLeft <= 0) { showGameOver(); return; }
    
    // Gi·∫£m l∆∞·ª£t v√† c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
    gameState.turnsLeft--; 
    updateUI();

    const rect = canvas.getBoundingClientRect();
    rod.x = e.clientX - rect.left;
    rod.y = e.clientY - rect.top;
    rod.lureY = 0; rod.isCast = true; messageBox.textContent = "C·∫ßn c√¢u ƒëang ƒë∆∞·ª£c th·∫£ xu·ªëng...";
  }

  function checkCatch() {
    let closestFish = null; let minDistance = Infinity;
    fishes.forEach(f => {
      const d = Math.hypot(rod.x - f.x, rod.y - f.y);
      if (d < minDistance) { minDistance = d; closestFish = f; }
    });
    if (closestFish) {
      closestFish.isTargeted = true;
      gameState.currentCaughtFish = null;
      messageBox.textContent = `üêü M·ªôt con c√° ${closestFish.size} ƒë√£ ph√°t hi·ªán m·ªìi! N√≥ ƒëang b∆°i l·∫°i...`;
    } else {
      messageBox.textContent = "üåä Kh√¥ng c√≥ c√° ·ªü khu v·ª±c n√†y! Th·ª≠ v·ªã tr√≠ kh√°c.";
      // Ch·ªâ reset rod n·∫øu kh√¥ng c√¢u ƒë∆∞·ª£c g√¨
      resetRodAndMessage("Kh√¥ng c√≥ c√°, th·ª≠ l·∫°i! L∆∞·ª£t c√≤n l·∫°i: " + gameState.turnsLeft);
    }
  }

  // -------------------- Quiz integration (use questions loaded earlier) --------------------
  function showQuizFromQuestions(fishScore) {
    if (!questions || questions.length === 0) {
      // fallback built-in questions if external JSON missing
      const fallback = [{question:"HTML tag t·∫°o li√™n k·∫øt l√† g√¨?", choices:["<a>","<link>","<nav>","<href>"], answer:0}];
      questions = fallback;
    }
    gameState.isQuizzing = true;
    // pick a random question from questions array
    const qi = Math.floor(Math.random() * questions.length);
    const q = questions[qi];

    gameState.currentQuestion = q;
    quizQuestionEl.innerText = `[C√° ${gameState.currentCaughtFish?.size || ''}: ${fishScore} ƒëi·ªÉm] ${q.question}`;
    quizOptionsEl.innerHTML = ''; quizFeedbackEl.innerText = ''; quizNextBtn.style.display = 'none';

    // shuffle choices
    const choices = q.choices.map((c,i)=>({text:c, originalIndex:i}));
    shuffleArray(choices);
    // find new index of correct answer
    q.shuffledAnswer = choices.findIndex(c => c.originalIndex === q.answer);

    choices.forEach((c, idx) => {
      const btn = document.createElement('button');
      btn.className = 'quiz-option';
      btn.innerText = `${String.fromCharCode(65 + idx)}. ${c.text}`;
      btn.onclick = () => handleQuizAnswer(btn, idx, q.shuffledAnswer);
      quizOptionsEl.appendChild(btn);
    });

    quizModal.style.display = 'flex';
  }

  function handleQuizAnswer(btn, selectedIdx, correctIdx) {
    // disable all options
    const opts = document.querySelectorAll('.quiz-option');
    opts.forEach(o => { o.onclick = null; o.classList.add('disabled'); o.style.pointerEvents = 'none'; });

    if (selectedIdx === correctIdx) {
      btn.classList.add('correct');
      gameState.score += gameState.currentFishScore;
      gameState.fishCaught++;
      quizFeedbackEl.innerText = `‚úÖ Ch√≠nh x√°c! B·∫°n nh·∫≠n ƒë∆∞·ª£c ${gameState.currentFishScore} ƒëi·ªÉm.`;
    } else {
      btn.classList.add('wrong');
      quizFeedbackEl.innerText = `‚ùå Sai r·ªìi. ƒê√°p √°n ƒë√∫ng ƒë√£ ƒë∆∞·ª£c t√¥.`;
      // mark correct
      opts[correctIdx].classList.add('correct');
    }
    updateUI();
    quizNextBtn.style.display = 'inline-block';
  }

  quizNextBtn.onclick = () => {
    // hide quiz and reset fish
    quizModal.style.display = 'none';
    gameState.isQuizzing = false;
    if (gameState.currentCaughtFish) {
      gameState.currentCaughtFish.reset();
      gameState.currentCaughtFish = null;
    }
    if (gameState.turnsLeft <= 0) showGameOver();
    else resetRodAndMessage("S·∫µn s√†ng c√¢u! L∆∞·ª£t c√≤n l·∫°i: " + gameState.turnsLeft);
  };


  // -------------------- UI helpers --------------------
  function updateUI() {
    totalScoreEl.innerText = gameState.score;
    fishCaughtEl.innerText = gameState.fishCaught;
    turnsLeftEl.innerText = gameState.turnsLeft;
    turnsLeftSmallEl.innerText = gameState.turnsLeft;
    document.getElementById('studentDisplay').innerText = studentName || '-';
  }

  function showGameOver() {
    // display end screen
    gameScreen.style.display = 'none';
    endScreen.style.display = 'block';
    finalScoreText.innerText = `T√™n: ${studentName} | T·ªïng ƒëi·ªÉm: ${gameState.score} ƒëi·ªÉm | C√° ƒë√£ c√¢u: ${gameState.fishCaught}`;
  }
  
  // Custom message box function (replacing alert())
  function showMessage(message, type="info") {
    endModal.style.display = 'flex';
    endContent.innerHTML = `
        <h3 style="margin-top:0;">${type === 'error' ? 'L·ªói' : (type === 'warning' ? 'C·∫£nh b√°o' : 'Th√¥ng b√°o')}</h3>
        <p>${message}</p>
        <button onclick="document.getElementById('endModal').style.display='none';" class="${type === 'warning' ? 'btn-secondary' : 'btn-danger'}" style="margin-top:10px;">ƒê√≥ng</button>
    `;
  }

  // -------------------- Google Sheet submission (same logic / date check) --------------------
  function sendToGoogleSheet(tenHS, diem) {
	  const lop = getParam("lop");  
	  const tuan = getParam("tuan");       // L·∫•y tu·∫ßn t·ª´ URL ho·∫∑c bi·∫øn
	  const ngaybdStr = getParam("ngaybd");// Ng√†y b·∫Øt ƒë·∫ßu t·ª´ URL
	  const ngayktStr = getParam("ngaykt");// Ng√†y k·∫øt th√∫c t·ª´ URL

	  // Ki·ªÉm tra tham s·ªë ng√†y
	  if (!ngaybdStr || !ngayktStr) {
		console.log("Thi·∫øu tham s·ªë ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c!");
		showMessage("G·ª≠i ƒëi·ªÉm th·∫•t b·∫°i: Thi·∫øu tham s·ªë ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c k·∫øt th√∫c trong URL.", "error");
		return;
	  }

	  const ngaybd = new Date(ngaybdStr);
	  const ngaykt = new Date(ngayktStr);
	  const now = new Date();

	  // ƒê·∫∑t gi·ªù v·ªÅ 00:00 ƒë·ªÉ so s√°nh ng√†y (Ch·ªâ so s√°nh ng√†y, b·ªè qua gi·ªù)
	  now.setHours(0, 0, 0, 0);
	  ngaybd.setHours(0, 0, 0, 0);
	  ngaykt.setHours(0, 0, 0, 0);

	  // Ch·ªâ g·ª≠i n·∫øu ƒëang trong th·ªùi gian h·ª£p l·ªá
	  if (now >= ngaybd && now <= ngaykt) {
		fetch(APPS_SCRIPT_URL, {
		  method: "POST",
		  mode: "no-cors", // tr√°nh l·ªói CORS
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({
			tenHS: tenHS,
			diem: diem,
			tuan: tuan,
			lop: lop 
		  })
		})
		.then(() => {
		  console.log("‚úÖ D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n Google Sheet!");
		  showMessage("‚úÖ Ho√†n th√†nh! D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i l√™n h·ªá th·ªëng.", "info");
		})
		.catch(e => {
            console.error("‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu:", e);
            showMessage("‚ùå L·ªói khi g·ª≠i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c th·ª≠ l·∫°i.", "error");
        });
	  } else {
		console.log("‚è≥ Kh√¥ng g·ª≠i d·ªØ li·ªáu: Ngo√†i th·ªùi gian h·ª£p l·ªá.");
        showMessage("‚è≥ Kh√¥ng g·ª≠i ƒëi·ªÉm: ƒê√£ h·∫øt th·ªùi gian cho ph√©p l√†m b√†i. Vui l√≤ng li√™n h·ªá gi√°o vi√™n.", "warning");
	  }
	}

  // -------------------- Controls bindings --------------------
  startBtn.addEventListener('click', () => {
    const name = studentInput.value.trim();
    if (!name) { showMessage("Vui l√≤ng nh·∫≠p t√™n c·ªßa h·ªçc sinh ƒë·ªÉ b·∫Øt ƒë·∫ßu!", "warning"); return; }
    if (!questions || questions.length === 0) { showMessage("D·ªØ li·ªáu c√¢u h·ªèi ch∆∞a s·∫µn s√†ng. Vui l√≤ng ƒë·ª£i ho·∫∑c ki·ªÉm tra URL JSON.", "error"); return; }
    
    studentName = name;
    
    // 1. Setup Game State
    gameState.score = 0; gameState.turnsLeft = 10; gameState.fishCaught = 0; gameState.currentCaughtFish = null; gameState.isQuizzing = false;
    
    // 2. Display Game Screen
    startScreen.style.display = 'none'; 
    gameScreen.style.display = 'block';
    
    // 3. FIX: Resize Canvas and Init Objects NOW (when gameScreen is visible)
    resizeCanvas();
    initGameObjects(); // C√° ƒë∆∞·ª£c t·∫°o v·ªõi k√≠ch th∆∞·ªõc Canvas ƒë√£ ƒë√∫ng

    // 4. Update UI & Start Game Loop
    updateUI();
    studentDisplay.innerText = studentName;
    messageBox.textContent = "S·∫µn s√†ng c√¢u! B·∫°n c√≥ 10 l∆∞·ª£t.";
    canvas.addEventListener('click', handleCast);
    requestAnimationFrame(animate); 
  });

  howBtn.addEventListener('click', () => {
    // Thay th·∫ø alert() b·∫±ng showMessage()
    showMessage("H∆∞·ªõng d·∫´n:\n1) Nh·∫≠p t√™n ‚Üí B·∫Øt ƒë·∫ßu.\n2) Click v√†o h·ªì (Canvas) ƒë·ªÉ th·∫£ c·∫ßn.\n3) N·∫øu c√¢u ƒë∆∞·ª£c c√°, tr·∫£ l·ªùi c√¢u h·ªèi ƒë·ªÉ ghi ƒëi·ªÉm.\n4) Game c√≥ 10 l∆∞·ª£t. Sau khi h·∫øt 10 l∆∞·ª£t, b·∫•m Ho√†n th√†nh ƒë·ªÉ g·ª≠i k·∫øt qu·∫£.", "info");
  });

  endReplayBtn.addEventListener('click', () => {
    location.reload();
  });

  endCompleteBtn.addEventListener('click', () => {
    // ƒê√É KH·∫ÆC PH·ª§C: S·ª≠ d·ª•ng studentName v√† gameState.score
    sendToGoogleSheet(studentName, gameState.score);
      // Gi·ªØ nguy√™n ·ªü m√†n h√¨nh k·∫øt th√∫c sau khi g·ª≠i ƒëi·ªÉm
      setTimeout(() => {
		history.back();
        // C√≥ th·ªÉ th√™m h√†nh ƒë·ªông ƒë√≥ng/th√¥ng b√°o chi ti·∫øt h∆°n t·∫°i ƒë√¢y
      }, 500);
  });

  // auto focus input
  document.addEventListener('DOMContentLoaded', () => { 
    // Ki·ªÉm tra v√† ƒë·∫∑t gi√° tr·ªã cho input n·∫øu c√≥ param studentName
    const urlStudentName = getParam('studentName');
    if (urlStudentName) {
        studentInput.value = urlStudentName;
        studentName = urlStudentName;
    }
    setTimeout(()=> studentInput.focus(), 150); 
  });

  // resize handling (v·∫´n gi·ªØ nguy√™n ƒë·ªÉ Canvas t·ª± ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc khi c·ª≠a s·ªï thay ƒë·ªïi)
  window.addEventListener('resize', resizeCanvas);

  </script>
</body>
</html>
