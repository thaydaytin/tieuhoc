<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bài Ôn Tập</title>

<style>
    body {
        font-family: "Nunito", Arial, sans-serif;
        background: #eef6ff;
        padding: 20px;
    }

    .paper {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    h1 {
        text-align: center;
        color: #4a8cff;
        margin-bottom: 20px;
    }

    .question {
        margin-bottom: 25px;
        padding: 15px;
        border-bottom: 1px solid #e4e4e4;
    }

    .question-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 18px;
    }

    /* Trắc nghiệm */
    .option {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        margin: 6px 0;
        border-radius: 10px;
        cursor: pointer;
        user-select: none;
        border: 2px solid transparent;
    }

    .circle {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 2px solid #888;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #555;
    }

    .option.selected .circle {
        border: 3px solid #4a8cff;
        background: #dcebff;
        color: #1a4fd1;
    }

    .option:hover {
        background: #f4f9ff;
    }

    /* Kết quả */
    .correct {
        background: #d7ffd9 !important;
        border: 2px solid #45c162 !important;
    }
    .wrong {
        background: #ffd7d7 !important;
        border: 2px solid #ff5959 !important;
    }

    /* Tự luận */
    textarea {
        width: 100%;
        height: 90px;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #cddfff;
        font-size: 15px;
    }

    .essay-answer {
        background: #fff7d6;
        padding: 12px;
        margin-top: 8px;
        border-radius: 10px;
        border: 2px solid #ffdea1;
        display: none;
    }

    #submit-btn, #retry-btn {
        padding: 12px 25px;
        margin-top: 20px;
        background: #4a8cff;
        color: white;
        font-size: 17px;
        border: none;
        border-radius: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        cursor: pointer;
    }

    #retry-btn {
        background: #45c162;
        display:none;
    }

    #score-box {
        margin-top: 25px;
        font-size: 20px;
        text-align: center;
        font-weight: bold;
        color: #4a8cff;
        display:none;
    }
</style>
</head>

<body>

<div class="paper">
    <h1 id="subject-title">Bài Ôn Tập</h1>

    <div id="questions-container"></div>

    <button id="submit-btn" onclick="submitExam()">Nộp bài</button>
    <button id="retry-btn" onclick="location.reload()">Làm lại</button>

    <div id="score-box"></div>
</div>

<script>
let data = [];
let studentAnswers = {};  
let studentEssay = {};
let mcq = [];
let essay = [];

function loadExam(jsonFile) {
    let subjectName = "";
    if (jsonFile.includes("cn3")) subjectName = "Công nghệ 3";
    if (jsonFile.includes("th3")) subjectName = "Tin học 3";
    if (jsonFile.includes("cn4")) subjectName = "Công nghệ 4";
    if (jsonFile.includes("th4")) subjectName = "Tin học 4";
    if (jsonFile.includes("cn5")) subjectName = "Công nghệ 5";
    if (jsonFile.includes("th5")) subjectName = "Tin học 5";

    document.getElementById("subject-title").innerText = subjectName;

    fetch(jsonFile)
    .then(res => res.json())
    .then(json => {
        data = json;
        mcq = data.filter(q => !q.type);
        essay = data.filter(q => q.type === "essay");
        renderQuestions();
    });
}

function renderQuestions() {
    let container = document.getElementById("questions-container");
    container.innerHTML = "";

    let allQuestions = [...mcq, ...essay];

    allQuestions.forEach((q, index) => {
        let div = document.createElement("div");
        div.className = "question";
        
        div.innerHTML = `<div class="question-title">Câu ${index+1}: ${q.question}</div>`;

        if (!q.type) {
            let letters = ["A","B","C","D"];
            q.options.forEach((opt, i) => {
                div.innerHTML += `
                    <div class="option" onclick="selectOption(${q.id}, '${letters[i]}', this)">
                        <div class="circle">${letters[i]}</div>
                        ${opt}
                    </div>`;
            });
        } else {
            div.innerHTML += `
                <textarea id="essay-${q.id}" placeholder="Nhập câu trả lời..."></textarea>
                <div id="essay-answer-${q.id}" class="essay-answer"></div>
            `;
        }

        container.appendChild(div);
    });
}

function selectOption(id, answer, el) {
    studentAnswers[id] = answer;

    let parent = el.parentNode;
    let options = parent.querySelectorAll(".option");
    options.forEach(o => o.classList.remove("selected"));

    el.classList.add("selected");
}

function normalize(str) {
    return str.normalize("NFD")
              .replace(/[\u0300-\u036f]/g,"")
              .toLowerCase()
              .replace(/[^a-z0-9 ]/g,"")
              .trim();
}

function similarity(a, b) {
    a = a.split(" ");
    b = b.split(" ");

    let match = 0;
    a.forEach(w1 => b.forEach(w2 => { if (w1 === w2) match++; }));

    return match / Math.max(a.length, b.length);
}

function submitExam() {
    let score = 0;

    // CHẤM TRẮC NGHIỆM
    mcq.forEach(q => {
        let chosen = studentAnswers[q.id];
        let correct = q.answer;

        let letters = ["A","B","C","D"];
        let options = document.querySelectorAll(`.question:nth-child(${q.id}) .option`);

        let questionDiv = document.querySelectorAll(".question")[q.id - 1];
        let optionDivs = questionDiv.querySelectorAll(".option");

        optionDivs.forEach(opt => {
            let letter = opt.querySelector(".circle").innerText;

            if (letter === correct) {
                opt.classList.add("correct");
            }

            if (letter === chosen && chosen !== correct) {
                opt.classList.add("wrong");
            }
        });

        if (chosen === correct) score += 0.5;
    });

    // CHẤM TỰ LUẬN
    essay.forEach(q => {
        let input = document.getElementById(`essay-${q.id}`).value;

        let student = normalize(input);
        let correct = normalize(q.answer);

        let sim = similarity(student, correct);

        let answerBox = document.getElementById(`essay-answer-${q.id}`);
        answerBox.style.display = "block";

        if (sim >= 0.5) {
            answerBox.innerHTML = `<b style="color:green;">✓ Chính xác!</b>`;
            score += 0.5;
        } else {
            answerBox.innerHTML = `<b style="color:red;">✗ Chưa đúng!</b><br><i>Gợi ý: ${q.answer}</i>`;
        }
    });

    document.getElementById("score-box").style.display = "block";
    document.getElementById("score-box").innerText = `Tổng điểm: ${score}/10`;
    document.getElementById("submit-btn").style.display = "none";
    document.getElementById("retry-btn").style.display = "block";
}

// ---- Thay file JSON ở đây -----
loadExam("cn3.json");
</script>

</body>
</html>
