<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Bài Ôn Tập</title>

<style>
    body {
        font-family: "Nunito", Arial, sans-serif;
		background: linear-gradient(120deg, #f6d5f7 0%, #fbe9d7 100%);
		padding: 20px;
    }

    /* Trang giấy */
    .paper {
        max-width: 900px;
        margin: auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
        display:none;
    }

    h1 {
        text-align: center;
        color: #4a8cff;
        margin-bottom: 20px;
    }

    /* Màn hình chọn môn */
    #subject-screen {
        max-width: 600px;
        margin: auto;
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0,0,0,0.15);
    }

    .grade-title {
        font-size: 20px;
        font-weight: bold;
        color: #4a8cff;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .subject-btn {
        padding: 12px 18px;
        margin: 6px;
        background: #4a8cff;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 16px;
        display:inline-block;
    }
    .subject-btn:hover {
        background:#2f6bd4;
    }

    .question {
        margin-bottom: 25px;
        padding: 15px;
        border-bottom: 1px solid #e4e4e4;
    }

    .question-title {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 18px;
    }

    /* Trắc nghiệm */
    .option {
        display: flex;
        align-items: center;
        padding: 8px 10px;
        margin: 6px 0;
        border-radius: 10px;
        cursor: pointer;
        user-select: none;
        border: 2px solid transparent;
    }

    .circle {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        border: 2px solid #888;
        margin-right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #555;
    }

    .option.selected .circle {
        border: 3px solid #4a8cff;
        background: #dcebff;
        color: #1a4fd1;
    }

    /* Kết quả */
    .correct {
        background: #d7ffd9 !important;
        border: 2px solid #45c162 !important;
    }
    .wrong {
        background: #ffd7d7 !important;
        border: 2px solid #ff5959 !important;
    }

    /* Tự luận */
    textarea {
        width: 100%;
        height: 90px;
        padding: 12px;
        border-radius: 10px;
        border: 2px solid #cddfff;
        font-size: 15px;
    }

    .essay-answer {
        background: #fff7d6;
        padding: 12px;
        margin-top: 8px;
        border-radius: 10px;
        border: 2px solid #ffdea1;
        display: none;
    }

    #submit-btn, #retry-btn {
        padding: 12px 25px;
        margin-top: 20px;
        background: #4a8cff;
        color: white;
        font-size: 17px;
        border: none;
        border-radius: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
        cursor: pointer;
    }

    #retry-btn {
        background: #45c162;
        display:none;
    }

    #score-box {
        margin-top: 25px;
        font-size: 20px;
        text-align: center;
        font-weight: bold;
        color: #4a8cff;
        display:none;
    }
</style>
</head>

<body>

<!-- MÀN HÌNH CHỌN MÔN -->
<div id="subject-screen">
    <h2 style="text-align:center; color:#4a8cff;">Chọn môn học</h2>

    <div class="grade-title">Lớp 3</div>
    <button class="subject-btn" onclick="startExam('th3.json')">Tin học 3</button>
    <button class="subject-btn" onclick="startExam('cn3.json')">Công nghệ 3</button>

    <div class="grade-title">Lớp 4</div>
    <button class="subject-btn" onclick="startExam('th4.json')">Tin học 4</button>
    <button class="subject-btn" onclick="startExam('cn4.json')">Công nghệ 4</button>

    <div class="grade-title">Lớp 5</div>
    <button class="subject-btn" onclick="startExam('th5.json')">Tin học 5</button>
    <button class="subject-btn" onclick="startExam('cn5.json')">Công nghệ 5</button>
</div>

<!-- TRANG GIẤY BÀI LÀM -->
<div class="paper" id="paper">
    <h1 id="subject-title">Bài Ôn Tập</h1>

    <div id="questions-container"></div>

    <button id="submit-btn" onclick="submitExam()">Nộp bài</button>
    <button id="retry-btn" onclick="location.reload()">Làm lại</button>

    <div id="score-box"></div>
</div>

<script>
let data = [];
let mcq = [];
let essay = [];
let studentAnswers = {};
let studentEssay = {};

function startExam(jsonFile) {
    document.getElementById("subject-screen").style.display = "none";
    document.getElementById("paper").style.display = "block";
    loadExam(jsonFile);
}

function loadExam(jsonFile) {
    let subjectName = jsonFile.includes("th3") ? "Tin học 3" :
                      jsonFile.includes("cn3") ? "Công nghệ 3" :
                      jsonFile.includes("th4") ? "Tin học 4" :
                      jsonFile.includes("cn4") ? "Công nghệ 4" :
                      jsonFile.includes("th5") ? "Tin học 5" :
                      "Công nghệ 5";

    document.getElementById("subject-title").innerText = subjectName;

    fetch(jsonFile).then(res => res.json()).then(json => {
        data = json;

        mcq = data.filter(q => !q.type);
        essay = data.filter(q => q.type === "essay");

        mcq = shuffle(mcq); // <-- XÁO TRỘN 16 CÂU

        renderQuestions();
    });
}

function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
}

function renderQuestions() {
    let container = document.getElementById("questions-container");
    container.innerHTML = "";

    let all = [...mcq, ...essay];

    all.forEach((q, i) => {
        let div = document.createElement("div");
        div.className = "question";

        div.innerHTML = `<div class="question-title">Câu ${i+1}: ${q.question}</div>`;

        if (!q.type) {
            let letters = ["A","B","C","D"];
            q.options.forEach((opt, idx) => {
                div.innerHTML += `
                    <div class="option" onclick="selectOption(${q.id}, '${letters[idx]}', this)">
                        <div class="circle">${letters[idx]}</div> ${opt}
                    </div>
                `;
            });
        } else {
            div.innerHTML += `
                <textarea id="essay-${q.id}" placeholder="Nhập câu trả lời..."></textarea>
                <div id="essay-answer-${q.id}" class="essay-answer"></div>
            `;
        }

        container.appendChild(div);
    });
}

function selectOption(id, answer, el) {
    studentAnswers[id] = answer;

    let parent = el.parentNode;
    let options = parent.querySelectorAll(".option");
    options.forEach(o => o.classList.remove("selected"));

    el.classList.add("selected");
}

function normalize(str) {
    return str.normalize("NFD")
              .replace(/[\u0300-\u036f]/g,"")
              .toLowerCase()
              .replace(/[^a-z0-9 ]/g,"")
              .trim();
}

function similarity(a, b) {
    a = a.split(" ");
    b = b.split(" ");

    let match = 0;
    a.forEach(w1 => b.forEach(w2 => { if (w1 === w2) match++; }));
    return match / Math.max(a.length, b.length);
}

function submitExam() {
    let score = 0;

    mcq.forEach(q => {
        let chosen = studentAnswers[q.id];
        let correct = q.answer;

        let questionDiv = [...document.querySelectorAll(".question")][mcq.indexOf(q)];
        let optionDivs = questionDiv.querySelectorAll(".option");

        optionDivs.forEach(opt => {
            let letter = opt.querySelector(".circle").innerText;
            if (letter === correct) opt.classList.add("correct");
            if (letter === chosen && chosen !== correct) opt.classList.add("wrong");
        });

        if (chosen === correct) score += 0.5;
    });

    essay.forEach(q => {
        let student = document.getElementById(`essay-${q.id}`).value;
        let sN = normalize(student);
        let aN = normalize(q.answer);

        let sim = similarity(sN, aN);
        let box = document.getElementById(`essay-answer-${q.id}`);

        box.style.display = "block";
        if (sim >= 0.5) {
            box.innerHTML = `<b style="color:green;">✓ Chính xác!</b>`;
            score += 0.5;
        } else {
            box.innerHTML = `<b style="color:red;">✗ Chưa đúng!</b><br><i>Gợi ý: ${q.answer}</i>`;
        }
    });

    document.getElementById("score-box").style.display = "block";
    document.getElementById("score-box").innerText = `Tổng điểm: ${score}/10`;

    document.getElementById("submit-btn").style.display = "none";
    document.getElementById("retry-btn").style.display = "block";
}
</script>

</body>
</html>
