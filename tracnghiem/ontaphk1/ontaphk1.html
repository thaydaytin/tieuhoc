<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>√în T·∫≠p Tr·∫Øc Nghi·ªám ‚Äì D·ªÖ Th∆∞∆°ng</title>
<style>
    body {
        font-family: "Comic Sans MS", Arial;
        background: linear-gradient(#dff3ff, #fef6ff);
        padding: 20px;
    }
    h1 {
        text-align: center;
        color: #ff6f91;
        text-shadow: 2px 2px #ffe7ef;
    }

    .subject-btn {
        padding: 14px 24px;
        margin: 8px;
        background: #ff9ec4;
        color: white;
        border: none;
        border-radius: 14px;
        cursor: pointer;
        font-size: 18px;
        box-shadow: 0 4px #e67faa;
    }
    .subject-btn:hover { background:#ff76ad; }

    #quiz-box {
        display:none;
        background:white;
        padding:25px;
        border-radius:20px;
        max-width:750px;
        margin:auto;
        box-shadow:0 0 20px rgba(255,150,200,0.5);
        border:4px solid #ffd6e8;
    }

    .answer {
        padding:12px;
        border:2px solid #cce6ff;
        border-radius:12px;
        margin-top:10px;
        cursor:pointer;
        background:#f2faff;
        transition:0.2s;
        position:relative;
        font-size:17px;
    }
    .answer:hover { background:#dff1ff; }

    .correct {
        background:#c3ffcf !important;
        border-color:#52d468;
    }
    .wrong {
        background:#ffd3d3 !important;
        border-color:#ff6b6b;
    }

    .icon {
        position:absolute;
        right:12px;
        top:50%;
        transform:translateY(-50%);
        font-weight:bold;
        font-size:20px;
    }
    .correct-icon { color:#1aa920; }
    .wrong-icon { color:#ff3b30; }

    #controls {
        margin-top:20px;
        text-align:center;
    }
    button {
        padding:12px 20px;
        margin:8px;
        border:none;
        border-radius:10px;
        font-size:16px;
        cursor:pointer;
    }
    #next-btn { background:#6ecbff; color:white; }
    #see-answer-btn { background:#ffb347; color:white; }

    #result-box {
        display:none;
        background:white;
        padding:20px;
        border-radius:16px;
        max-width:650px;
        margin:20px auto;
        box-shadow:0 0 15px rgba(150,200,255,0.5);
        border:3px solid #bfe4ff;
        text-align:center;
    }
    #result-box h2 { color:#ff6f91; }

    #answer-display {
        margin-top:15px;
        background:#fff6d1;
        padding:12px;
        border-radius:10px;
        border:2px solid #ffe39b;
        font-size:17px;
        display:none;
    }
</style>
</head>

<body>

<h1>üåü √în T·∫≠p Ki·∫øn Th·ª©c ‚Äì H·ªçc M√† Ch∆°i üåü</h1>

<div id="subject-box" style="text-align:center;">
    <button class="subject-btn" onclick="loadSubject('cn3.json')">C√¥ng Ngh·ªá 3</button>
    <button class="subject-btn" onclick="loadSubject('th3.json')">Tin H·ªçc 3</button><br>
    <button class="subject-btn" onclick="loadSubject('cn4.json')">C√¥ng Ngh·ªá 4</button>
    <button class="subject-btn" onclick="loadSubject('th4.json')">Tin H·ªçc 4</button><br>
    <button class="subject-btn" onclick="loadSubject('cn5.json')">C√¥ng Ngh·ªá 5</button>
    <button class="subject-btn" onclick="loadSubject('th5.json')">Tin H·ªçc 5</button>
</div>

<!-- ================= KHUNG C√ÇU H·ªéI ================= -->
<div id="quiz-box">
    <h2 id="question-text"></h2>
    <div id="answers"></div>
    <div id="answer-display"></div>

    <div id="controls">
        <button id="see-answer-btn" onclick="showEssayAnswer()" style="display:none;">
            Xem ƒë√°p √°n
        </button>
        <button id="next-btn" onclick="nextQuestion()">C√¢u ti·∫øp ‚ûú</button>
    </div>
</div>

<!-- ================ B·∫¢NG K·∫æT QU·∫¢ ================ -->
<div id="result-box">
    <h2>üéâ Ho√†n th√†nh b√†i l√†m! üéâ</h2>
    <p id="mcq-score"></p>
    <p id="essay-score"></p>
    <h3 id="total-score"></h3>

    <button onclick="restartQuiz()" style="padding:12px 25px; background:#8ef58e; color:white; border-radius:10px;">
        üîÑ L√†m l·∫°i b√†i
    </button>
</div>

<script>
let data = [];
let mcq = [];
let essay = [];
let index = 0;
let scoreMCQ = 0;
let scoreEssay = 0;
let viewedEssay = {};

function loadSubject(filename) {
    fetch(filename)
    .then(res => res.json())
    .then(json => {
        data = json;
        mcq = data.filter(q => !q.type);
        essay = data.filter(q => q.type === "essay");

        mcq = shuffle(mcq);

        index = 0;
        scoreMCQ = 0;
        scoreEssay = 0;
        viewedEssay = {};

        document.getElementById("subject-box").style.display = "none";
        document.getElementById("result-box").style.display = "none";
        document.getElementById("quiz-box").style.display = "block";

        showQuestion();
    });
}

function showQuestion() {
    let q;

    document.getElementById("answer-display").style.display = "none";
    document.getElementById("answers").innerHTML = "";

    if (index < mcq.length) q = mcq[index];
    else q = essay[index - mcq.length];

    document.getElementById("question-text").innerText =
        "C√¢u " + (index + 1) + ": " + q.question;

    if (!q.type) {
        document.getElementById("see-answer-btn").style.display = "none";

        q.options.forEach((opt, i) => {
            let div = document.createElement("div");
            div.className = "answer";
            div.innerText = opt;
            div.onclick = () => checkAnswer(div, i, q.answer);
            document.getElementById("answers").appendChild(div);
        });

    } else {
       document.getElementById("answers").innerHTML = `
		<p style="font-size:18px; color:#999;">H√£y nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa em:</p>
		<textarea id="essay-input"
			style="width:100%; height:80px; padding:10px; border-radius:10px; border:2px solid #ffd6a5; font-size:16px;">
		</textarea>

		<button onclick="checkEssayAnswer()" 
			style="margin-top:10px; background:#ffb347; color:white; padding:10px 20px; border-radius:10px; font-size:16px;">
			Tr·∫£ l·ªùi
		</button>
	`;

	document.getElementById("see-answer-btn").style.display = "none";

    }
}

function checkAnswer(div, idx, correctLetter) {
    let all = document.querySelectorAll(".answer");
    let letters = ["A","B","C","D"];
    let chosen = letters[idx];

    if (chosen === correctLetter) {
        div.classList.add("correct");
        div.innerHTML += `<span class="icon correct-icon">‚úì</span>`;
        scoreMCQ += 0.5;
    } else {
        div.classList.add("wrong");
        div.innerHTML += `<span class="icon wrong-icon">‚úó</span>`;

        let correctIndex = letters.indexOf(correctLetter);
        all[correctIndex].classList.add("correct");
        all[correctIndex].innerHTML += `<span class="icon correct-icon">‚úì</span>`;
    }

    all.forEach(a => a.onclick = null);
}

function checkEssayAnswer() {
    let q = essay[index - mcq.length];
    let student = document.getElementById("essay-input").value;

    if (student.trim() === "") {
        alert("Em h√£y nh·∫≠p c√¢u tr·∫£ l·ªùi tr∆∞·ªõc nh√©!");
        return;
    }

    // Chu·∫©n h√≥a chu·ªói
    let studentN = normalizeText(student);
    let answerN = normalizeText(q.answer);

    // T√≠nh ƒë·ªô t∆∞∆°ng ƒë·ªìng
    let score = similarity(studentN, answerN);

    // Hi·ªán ƒë√°p √°n ph√≠a d∆∞·ªõi
    let answerBox = document.getElementById("answer-display");
    answerBox.style.display = "block";

    if (score >= 0.5) {
        answerBox.innerHTML = `<b style="color:green;">‚úì Ch√≠nh x√°c!</b><br>üìò ƒê√°p √°n ƒë·∫ßy ƒë·ªß: ${q.answer}`;
        scoreEssay += 0.5;
    } else {
        answerBox.innerHTML = `<b style="color:red;">‚úó Ch∆∞a ƒë√∫ng!</b><br>üìò ƒê√°p √°n ƒë√∫ng l√†: ${q.answer}`;
    }

    document.getElementById("essay-input").disabled = true;
}


function showEssayAnswer() {
    let q = essay[index - mcq.length];

    if (!viewedEssay[q.id]) {
        scoreEssay += 0.5;
        viewedEssay[q.id] = true;
    }

    document.getElementById("answer-display").innerHTML =
        `<b>üìò ƒê√°p √°n:</b><br>${q.answer}`;

    document.getElementById("answer-display").style.display = "block";
}

function nextQuestion() {
    index++;

    if (index < mcq.length + essay.length) {
        showQuestion();
    } else showResult();
}

function showResult() {
    document.getElementById("quiz-box").style.display = "none";
    document.getElementById("result-box").style.display = "block";

    document.getElementById("mcq-score").innerText =
        "üí° ƒêi·ªÉm tr·∫Øc nghi·ªám: " + scoreMCQ.toFixed(1);

    document.getElementById("essay-score").innerText =
        "üìù ƒêi·ªÉm t·ª± lu·∫≠n: " + scoreEssay.toFixed(1);

    let total = (scoreMCQ + scoreEssay).toFixed(1);

    document.getElementById("total-score").innerHTML =
        "<b>‚≠ê T·ªïng ƒëi·ªÉm: " + total + " / 10 ‚≠ê</b>";
}

function restartQuiz() {
    location.reload();
}

function shuffle(arr) {
    return arr.sort(() => Math.random() - 0.5);
}

// B·ªè d·∫•u ti·∫øng Vi·ªát ƒë·ªÉ d·ªÖ so s√°nh
function normalizeText(str) {
    return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .toLowerCase()
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, " ")
        .trim();
}

// T√≠nh ƒë·ªô t∆∞∆°ng ƒë·ªìng gi·ªØa hai c√¢u
function similarity(a, b) {
    let A = a.split(" ");
    let B = b.split(" ");
    let matches = 0;

    A.forEach(wordA => {
        B.forEach(wordB => {
            if (wordA === wordB) matches++;
        });
    });

    return matches / Math.max(A.length, B.length);
}
</script>

</body>
</html>
